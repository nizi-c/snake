import router from '@ohos.router';
import { SnakeGame, Direction, Position, FoodType } from '../models/SnakeGame';
import image from '@ohos.multimedia.image';
import preferences from '@ohos.data.preferences';

interface FoodImageConfig {
  type: FoodType;
  file: string;
}

@Entry
@Component
struct GamePage {
  @State game: SnakeGame = new SnakeGame(200);
  @State isPlaying: boolean = false;
  @State isPaused: boolean = false;
  @State gameMode: string = 'casual';
  @State updateFlag: number = 0;
  @State currentTime: string = '00:00';
  @State controlMode: string = 'button'; // 'button' Êàñ 'click'
  @State showControlDialog: boolean = false;
  @State showMenuDialog: boolean = false;
  @State showCharacterDialog: boolean = false;
  @State dialogSize: number = 300;
  @State currentCharacter: string = 'cat'; // ÂΩìÂâçËßíËâ≤Ôºöcat, dog, rabbit, hamster
  private timerId: number = -1;
  private cellSize: number = 30;
  private canvasContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(new RenderingContextSettings(true));
  private foodImages: Map<FoodType, image.PixelMap> = new Map();
  private cartImage: image.PixelMap | null = null;
  private catImage: image.PixelMap | null = null;

  async aboutToAppear() {
    await this.loadGameSettings();
  }

  onPageShow() {
    // È°µÈù¢ÊòæÁ§∫Êó∂Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩ
    const params = router.getParams() as Record<string, Object>;
    if (params?.reload) {
      this.loadGameSettings();
    }
  }

  async loadGameSettings() {
    const params = router.getParams() as Record<string, Object>;
    this.gameMode = (params?.mode as string) || 'casual';
    
    let baseSpeed = this.gameMode === 'challenge' ? 100 : 200;
    let gridWidth = 22;
    let gridHeight = 15;
    let characterImage = 'cat.png';
    
    // Ê£ÄÊü•ÊòØÂê¶‰ªéËÆæÁΩÆÈ°µÈù¢ÊàñËßíËâ≤ÈÄâÊã©È°µÈù¢ËøîÂõû
    if (params?.reload) {
      if (params?.gridWidth) {
        gridWidth = params.gridWidth as number;
      }
      if (params?.gridHeight) {
        gridHeight = params.gridHeight as number;
      }
      if (params?.baseSpeed) {
        baseSpeed = params.baseSpeed as number;
      }
      if (params?.character) {
        characterImage = params.character as string;
        await this.loadCharacterImage(characterImage);
      }
      console.info('Reloading game with new settings - gridWidth:', gridWidth, 'gridHeight:', gridHeight, 'baseSpeed:', baseSpeed, 'character:', characterImage);
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage);
      this.stopGame();
      this.drawGame();
      return;
    }
    
    // Âä†ËΩΩËÆæÁΩÆ
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      gridWidth = await prefs.get('gridWidth', 22) as number;
      gridHeight = await prefs.get('gridHeight', 15) as number;
      characterImage = await prefs.get('character', 'cat.png') as string;
      
      // Âè™Âú®‰ºëÈó≤Ê®°Âºè‰ΩøÁî®Ëá™ÂÆö‰πâÈÄüÂ∫¶ÔºåÊåëÊàòÊ®°ÂºèÂõ∫ÂÆö‰∏∫100ms
      if (this.gameMode === 'casual') {
        baseSpeed = await prefs.get('baseSpeed', 200) as number;
      }
      
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage);
    } catch (err) {
      console.error('Failed to load settings:', err);
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage);
    }
  }

  async loadCharacterImage(characterFile: string) {
    try {
      const context = getContext(this);
      const resourceMgr = context.resourceManager;
      const catData = await resourceMgr.getRawFileContent(characterFile);
      const catSource = image.createImageSource(catData.buffer);
      this.catImage = await catSource.createPixelMap();
      console.info(`${characterFile} loaded successfully`);
    } catch (err) {
      console.error(`Failed to load ${characterFile}:`, JSON.stringify(err));
    }
  }

  async loadFruitImage() {
    try {
      const context = getContext(this);
      const resourceMgr = context.resourceManager;
      
      // Âä†ËΩΩÊâÄÊúâÈ£üÁâ©ÂõæÁâá
      const foodFiles: FoodImageConfig[] = [
        { type: FoodType.FRUIT, file: 'fruit.png' } as FoodImageConfig,
        { type: FoodType.ORANGE, file: 'orange.png' } as FoodImageConfig,
        { type: FoodType.WATERMELON, file: 'watermelon.png' } as FoodImageConfig,
        { type: FoodType.MUSHROOM, file: 'mushroom.png' } as FoodImageConfig,
        { type: FoodType.LEMON, file: 'lemon.png' } as FoodImageConfig,
        { type: FoodType.FLOWER, file: 'flower.png' } as FoodImageConfig
      ];
      
      for (const food of foodFiles) {
        try {
          const fileData = await resourceMgr.getRawFileContent(food.file);
          const imageSource = image.createImageSource(fileData.buffer);
          const pixelMap = await imageSource.createPixelMap();
          this.foodImages.set(food.type, pixelMap);
          console.info(`${food.file} loaded successfully`);
        } catch (err) {
          console.error(`Failed to load ${food.file}:`, JSON.stringify(err));
        }
      }
      
      // Âä†ËΩΩËõáË∫´ÂõæÁâá
      try {
        const cartData = await resourceMgr.getRawFileContent('cart.png');
        const cartSource = image.createImageSource(cartData.buffer);
        this.cartImage = await cartSource.createPixelMap();
        console.info('cart.png loaded successfully');
      } catch (err) {
        console.error('Failed to load cart.png:', JSON.stringify(err));
      }
      
      // Âä†ËΩΩËõáÂ§¥ÂõæÁâá
      try {
        const catData = await resourceMgr.getRawFileContent('cat.png');
        const catSource = image.createImageSource(catData.buffer);
        this.catImage = await catSource.createPixelMap();
        console.info('cat.png loaded successfully');
      } catch (err) {
        console.error('Failed to load cat.png:', JSON.stringify(err));
      }
      
      this.drawGame();
    } catch (err) {
      console.error('Failed to load images:', JSON.stringify(err));
    }
  }

  aboutToDisappear() {
    this.stopGame();
  }

  startGame() {
    if (this.game.isOver()) {
      this.game.init();
    }
    this.game.startTimer();
    this.isPlaying = true;
    this.isPaused = false;
    this.gameLoop();
  }

  stopGame() {
    this.isPlaying = false;
    this.isPaused = false;
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
  }

  pauseGame() {
    this.isPaused = true;
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
  }

  resumeGame() {
    this.isPaused = false;
    this.gameLoop();
  }

  restartGame() {
    this.stopGame();
    this.game.init();
    this.startGame();
  }

  gameLoop() {
    if (!this.isPlaying || this.isPaused) return;

    const success = this.game.update();
    this.updateFlag++;
    this.currentTime = this.game.getFormattedTime();
    this.drawGame();

    if (!success) {
      this.stopGame();
      return;
    }

    this.timerId = setTimeout(() => {
      this.gameLoop();
    }, this.game.getSpeed());
  }

  handleDirection(dir: Direction) {
    this.game.setDirection(dir);
    if (!this.isPlaying && !this.game.isOver()) {
      this.startGame();
    } else if (this.isPaused) {
      this.resumeGame();
    }
  }

  handleCanvasClick(x: number, y: number) {
    if (this.controlMode !== 'click') return;

    const head = this.game.getSnake()[0];
    const headX = head.x * this.cellSize + this.cellSize / 2;
    const headY = head.y * this.cellSize + this.cellSize / 2;

    const direction = this.game.getDirection();

    // Ê†πÊçÆÂΩìÂâçÊñπÂêëÂà§Êñ≠Â∑¶Âè≥
    let isRight = false;
    if (direction === Direction.UP) {
      isRight = x > headX;
    } else if (direction === Direction.DOWN) {
      isRight = x < headX;
    } else if (direction === Direction.LEFT) {
      isRight = y < headY;
    } else if (direction === Direction.RIGHT) {
      isRight = y > headY;
    }

    if (isRight) {
      this.game.turnRight();
    } else {
      this.game.turnLeft();
    }

    if (!this.isPlaying && !this.game.isOver()) {
      this.startGame();
    } else if (this.isPaused) {
      this.resumeGame();
    }
  }

  getSpeedColor(): string {
    const ratio = this.game.getCurrentSpeedRatio();
    if (ratio >= 1.5) return '#FF5722'; // ÂæàÂø´ - Á∫¢Ëâ≤
    if (ratio >= 1.2) return '#FF9800'; // Âø´ - Ê©ôËâ≤
    if (ratio >= 0.8) return '#4CAF50'; // Ê≠£Â∏∏ - ÁªøËâ≤
    return '#2196F3'; // ÊÖ¢ - ËìùËâ≤
  }

  @Builder
  MenuDialog() {
    Column() {
      Text('ËèúÂçï')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 20 })

      // ËßíËâ≤ÈÄâÊã©ÊåâÈíÆ
      Button('ËßíËâ≤ÈÄâÊã©')
        .width('100%')
        .height(50)
        .fontSize(18)
        .backgroundColor('#FF5722')
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.stopGame();
          router.pushUrl({
            url: 'pages/CharacterSelectPage'
          });
        })

      // ÊéßÂà∂ÊñπÂºèÊåâÈíÆ
      Button('ÊéßÂà∂ÊñπÂºè')
        .width('100%')
        .height(50)
        .fontSize(18)
        .backgroundColor('#9C27B0')
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.showControlDialog = true;
        })

      // ËÆæÁΩÆÊåâÈíÆ
      if (this.gameMode === 'casual') {
        Button('ËÆæÁΩÆ')
          .width('100%')
          .height(50)
          .fontSize(18)
          .backgroundColor('#2196F3')
          .margin({ bottom: 15 })
          .onClick(() => {
            this.showMenuDialog = false;
            this.stopGame();
            router.pushUrl({
              url: 'pages/SettingsPage'
            });
          })
      }

      // ÂèñÊ∂àÊåâÈíÆ
      Button('ÂèñÊ∂à')
        .width('100%')
        .height(50)
        .fontSize(18)
        .backgroundColor('#666666')
        .onClick(() => {
          this.showMenuDialog = false;
        })
    }
    .width('60%')
    .padding(25)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
  }

  @Builder
  ControlDialog() {
    Column() {
      Text('ÈÄâÊã©ÊéßÂà∂ÊñπÂºè')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ bottom: 30 })

      // ÊåâÈîÆÊéßÂà∂
      Column() {
        Row() {
          Radio({ value: 'button', group: 'controlGroup' })
            .checked(this.controlMode === 'button')
            .onChange((isChecked: boolean) => {
              if (isChecked) {
                this.controlMode = 'button';
              }
            })

          Column() {
            Text('ÊåâÈîÆÊéßÂà∂')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 5 })

            Text('‰ΩøÁî®Â±èÂπï‰∏ãÊñπÁöÑÊñπÂêëÊåâÈíÆÊéßÂà∂ËõáÁöÑÁßªÂä®ÊñπÂêë')
              .fontSize(14)
              .fontColor('#666666')
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 10 })
          .layoutWeight(1)
        }
        .width('100%')
        .padding(15)
        .backgroundColor(this.controlMode === 'button' ? '#E3F2FD' : '#F5F5F5')
        .borderRadius(8)
        .onClick(() => this.controlMode = 'button')
      }
      .width('100%')
      .margin({ bottom: 15 })

      // ÁÇπÂáªÊéßÂà∂
      Column() {
        Row() {
          Radio({ value: 'click', group: 'controlGroup' })
            .checked(this.controlMode === 'click')
            .onChange((isChecked: boolean) => {
              if (isChecked) {
                this.controlMode = 'click';
              }
            })

          Column() {
            Text('ÁÇπÂáªÊéßÂà∂')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 5 })

            Text('ÁÇπÂáªÊ∏∏ÊàèÂå∫ÂüüÔºöËõáÂè≥‰æßÂè≥ËΩ¨ÔºåËõáÂ∑¶‰æßÂ∑¶ËΩ¨')
              .fontSize(14)
              .fontColor('#666666')
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 10 })
          .layoutWeight(1)
        }
        .width('100%')
        .padding(15)
        .backgroundColor(this.controlMode === 'click' ? '#E3F2FD' : '#F5F5F5')
        .borderRadius(8)
        .onClick(() => this.controlMode = 'click')
      }
      .width('100%')
      .margin({ bottom: 30 })

      Button('Á°ÆÂÆö')
        .width('100%')
        .height(50)
        .fontSize(18)
        .backgroundColor('#2196F3')
        .onClick(() => {
          this.showControlDialog = false;
        })
    }
    .width(this.dialogSize)
    .height(this.dialogSize)
    .padding(25)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .justifyContent(FlexAlign.Center)
    .onAreaChange((oldValue: Area, newValue: Area) => {
      // ÂΩìÂå∫ÂüüÊîπÂèòÊó∂ÔºåÁ°Æ‰øù‰øùÊåÅÊ≠£ÊñπÂΩ¢
      const width = newValue.width as number;
      this.dialogSize = Math.min(width, 400);
    })
  }

  build() {
    Stack() {
      Column() {
        // È°∂ÈÉ®‰ø°ÊÅØÊ†è
        Column() {
          Row() {
            Button('ËøîÂõû')
              .fontSize(16)
              .backgroundColor('#666666')
              .onClick(() => {
                this.stopGame();
                router.back();
              })

            Row() {
              Text(`${this.gameMode === 'casual' ? '‰ºëÈó≤Ê®°Âºè' : 'ÊåëÊàòÊ®°Âºè'}`)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
            }
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)

            Row() {
              Column() {
                Text(`ÂæóÂàÜ: ${this.game.getScore()}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                
                Text(`ÈÄüÂ∫¶: ${this.game.getCurrentSpeedRatio().toFixed(1)}x`)
                  .fontSize(14)
                  .fontColor(this.getSpeedColor())
              }
              .alignItems(HorizontalAlign.End)
              .margin({ right: 10 })

              Button('‚ãÆ')
                .fontSize(24)
                .width(40)
                .height(40)
                .backgroundColor('#E0E0E0')
                .onClick(() => {
                  this.showMenuDialog = true;
                })
            }
          }
          .width('100%')
          .height(50)
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 20, right: 20 })

          // Á¨¨‰∫åË°åÔºöÊó∂Èó¥„ÄÅÈÄüÂ∫¶ÂíåÊéßÂà∂ÊåâÈíÆ
          Row() {
            Column() {
              Text(`Êó∂Èó¥: ${this.currentTime}`)
                .fontSize(16)
                .fontColor('#666666')
              
              Row() {
                Text(`ÈÄüÂ∫¶: ${this.game.getSpeed()}ms`)
                  .fontSize(14)
                  .fontColor('#999999')
                
                if (this.game.getCharacter() === 'cat.png' && this.game.getMushroomImmunity() > 0) {
                  Text(` | üõ°Ô∏è√ó${this.game.getMushroomImmunity()}`)
                    .fontSize(14)
                    .fontColor('#FF9800')
                }
              }
            }
            .alignItems(HorizontalAlign.Start)

            if (this.gameMode === 'casual') {
              Row() {
                if (!this.isPlaying || this.game.isOver()) {
                  Button('ÂºÄÂßã')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor('#4CAF50')
                    .onClick(() => this.startGame())
                } else if (this.isPaused) {
                  Button('ÁªßÁª≠')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor('#4CAF50')
                    .onClick(() => this.resumeGame())
                } else {
                  Button('ÊöÇÂÅú')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor('#FF9800')
                    .onClick(() => this.pauseGame())
                }

                Button('ÈáçÂºÄ')
                  .fontSize(14)
                  .height(32)
                  .backgroundColor('#2196F3')
                  .margin({ left: 10 })
                  .onClick(() => this.restartGame())
              }
            }
          }
          .width('100%')
          .height(40)
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 20, right: 20 })
        }
        .width('100%')
        .backgroundColor('#FFFFFF')

        // Ê∏∏ÊàèÂå∫Âüü
        Column() {
          Canvas(this.canvasContext)
            .width(this.game.getGridWidth() * this.cellSize)
            .height(this.game.getGridHeight() * this.cellSize)
            .backgroundColor('#000000')
            .onReady(() => {
              this.loadFruitImage();
              this.drawGame();
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Down) {
                this.handleCanvasClick(event.touches[0].x, event.touches[0].y);
              }
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#222222')

        // Ê∏∏ÊàèÁªìÊùüÊèêÁ§∫
        if (this.game.isOver()) {
          Column() {
            Text('Ê∏∏ÊàèÁªìÊùü!')
              .fontSize(36)
              .fontColor('#FF0000')
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })

            Text(`ÂæóÂàÜ: ${this.game.getScore()}`)
              .fontSize(24)
              .fontColor('#333333')
              .margin({ bottom: 10 })

            Text(`Â≠òÊ¥ªÊó∂Èó¥: ${this.currentTime}`)
              .fontSize(20)
              .fontColor('#666666')
              .margin({ bottom: 30 })

            Button('ÈáçÊñ∞ÂºÄÂßã')
              .fontSize(20)
              .width(160)
              .height(50)
              .backgroundColor('#4CAF50')
              .onClick(() => {
                this.restartGame();
              })
          }
          .width(300)
          .padding(30)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .shadow({ radius: 20, color: '#00000030' })
          .position({ x: '50%', y: '40%' })
          .translate({ x: '-50%', y: '-50%' })
        }

        // ÊöÇÂÅúÊèêÁ§∫
        if (this.isPaused && !this.game.isOver()) {
          Column() {
            Text('Ê∏∏ÊàèÂ∑≤ÊöÇÂÅú')
              .fontSize(32)
              .fontColor('#FF9800')
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 20 })

            Text('ÁÇπÂáª"ÁªßÁª≠"ÊàñÊñπÂêëÈîÆÊÅ¢Â§çÊ∏∏Êàè')
              .fontSize(16)
              .fontColor('#666666')
          }
          .width(280)
          .padding(30)
          .backgroundColor('#FFFFFF')
          .borderRadius(16)
          .shadow({ radius: 20, color: '#00000030' })
          .position({ x: '50%', y: '40%' })
          .translate({ x: '-50%', y: '-50%' })
        }

        // ÊéßÂà∂ÊåâÈíÆÔºà‰ªÖÂú®ÊåâÈîÆÊ®°ÂºèÊòæÁ§∫Ôºâ
        if (this.controlMode === 'button') {
          Column() {
            Row() {
              Button('‚Üë')
                .width(80)
                .height(80)
                .fontSize(32)
                .backgroundColor('#2196F3')
                .opacity(0.4)
                .onClick(() => this.handleDirection(Direction.UP))
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 10 })

            Row() {
              Button('‚Üê')
                .width(80)
                .height(80)
                .fontSize(32)
                .backgroundColor('#2196F3')
                .opacity(0.4)
                .margin({ right: 10 })
                .onClick(() => this.handleDirection(Direction.LEFT))

              Button('‚Üì')
                .width(80)
                .height(80)
                .fontSize(32)
                .backgroundColor('#2196F3')
                .opacity(0.4)
                .margin({ right: 10 })
                .onClick(() => this.handleDirection(Direction.DOWN))

              Button('‚Üí')
                .width(80)
                .height(80)
                .fontSize(32)
                .backgroundColor('#2196F3')
                .opacity(0.4)
                .onClick(() => this.handleDirection(Direction.RIGHT))
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
          }
          .width('100%')
          .padding({ top: 20, bottom: 40 })
          .backgroundColor(Color.Transparent)
        }
      }
      .width('100%')
      .height('100%')

      // ËèúÂçïÂºπÁ™ó
      if (this.showMenuDialog) {
        Column() {
          this.MenuDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showMenuDialog = false;
        })
        .onAreaChange((oldValue: Area, newValue: Area) => {
          // Ê†πÊçÆÂ±èÂπïÂÆΩÂ∫¶Ë∞ÉÊï¥ÂºπÁ™óÂ§ßÂ∞è
          const screenWidth = newValue.width as number;
          this.dialogSize = Math.min(screenWidth * 0.8, 400);
        })
      }

      // ÊéßÂà∂ÊñπÂºèÈÄâÊã©ÂºπÁ™ó
      if (this.showControlDialog) {
        Column() {
          this.ControlDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showControlDialog = false;
        })
      }
    }
    .width('100%')
    .height('100%')
  }

  private drawGame() {
    const ctx = this.canvasContext;
    const gridWidth = this.game.getGridWidth();
    const gridHeight = this.game.getGridHeight();

    // Ê∏ÖÁ©∫ÁîªÂ∏É
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, gridWidth * this.cellSize, gridHeight * this.cellSize);

    // ÁªòÂà∂ÁΩëÊ†ºÁ∫ø
    ctx.strokeStyle = '#333333';
    ctx.lineWidth = 1;
    for (let i = 0; i <= gridWidth; i++) {
      ctx.beginPath();
      ctx.moveTo(i * this.cellSize, 0);
      ctx.lineTo(i * this.cellSize, gridHeight * this.cellSize);
      ctx.stroke();
    }
    for (let i = 0; i <= gridHeight; i++) {
      ctx.beginPath();
      ctx.moveTo(0, i * this.cellSize);
      ctx.lineTo(gridWidth * this.cellSize, i * this.cellSize);
      ctx.stroke();
    }

    // ÁªòÂà∂Ëõá
    const snake = this.game.getSnake();
    snake.forEach((segment, index) => {
      if (index === 0) {
        // ËõáÂ§¥‰ΩøÁî®cat2ÂõæÁâá
        if (this.catImage) {
          try {
            ctx.drawImage(
              this.catImage,
              segment.x * this.cellSize,
              segment.y * this.cellSize,
              this.cellSize,
              this.cellSize
            );
          } catch (err) {
            console.error('Failed to draw cat image:', err);
            // ÁªòÂà∂Â§±Ë¥•Êó∂‰ΩøÁî®ÁªøËâ≤ÊñπÂùó
            ctx.fillStyle = '#00FF00';
            ctx.fillRect(
              segment.x * this.cellSize + 1,
              segment.y * this.cellSize + 1,
              this.cellSize - 2,
              this.cellSize - 2
            );
          }
        } else {
          // ÂõæÁâáÊú™Âä†ËΩΩÊó∂‰ΩøÁî®ÁªøËâ≤ÊñπÂùó
          ctx.fillStyle = '#00FF00';
          ctx.fillRect(
            segment.x * this.cellSize + 1,
            segment.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else if (this.cartImage) {
        // ËõáË∫´ÂíåËõáÂ∞æ‰ΩøÁî®cartÂõæÁâá
        try {
          ctx.drawImage(
            this.cartImage,
            segment.x * this.cellSize,
            segment.y * this.cellSize,
            this.cellSize,
            this.cellSize
          );
        } catch (err) {
          console.error('Failed to draw cart image:', err);
          // ÁªòÂà∂Â§±Ë¥•Êó∂‰ΩøÁî®ÁªøËâ≤ÊñπÂùó
          ctx.fillStyle = '#00CC00';
          ctx.fillRect(
            segment.x * this.cellSize + 1,
            segment.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else {
        // ÂõæÁâáÊú™Âä†ËΩΩÊó∂‰ΩøÁî®ÁªøËâ≤ÊñπÂùó
        ctx.fillStyle = '#00CC00';
        ctx.fillRect(
          segment.x * this.cellSize + 1,
          segment.y * this.cellSize + 1,
          this.cellSize - 2,
          this.cellSize - 2
        );
      }
    });

    // ÁªòÂà∂È£üÁâ©
    const foods = this.game.getFoods();
    
    foods.forEach(food => {
      const foodImage = this.foodImages.get(food.type);
      
      if (foodImage) {
        try {
          ctx.drawImage(
            foodImage,
            food.position.x * this.cellSize,
            food.position.y * this.cellSize,
            this.cellSize,
            this.cellSize
          );
        } catch (err) {
          console.error('Failed to draw food image:', err);
          // ÁªòÂà∂Â§±Ë¥•Êó∂‰ΩøÁî®Á∫¢Ëâ≤ÊñπÂùó
          ctx.fillStyle = '#FF0000';
          ctx.fillRect(
            food.position.x * this.cellSize + 1,
            food.position.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else {
        // ÂõæÁâáÊú™Âä†ËΩΩÊó∂‰ΩøÁî®Á∫¢Ëâ≤ÊñπÂùó
        ctx.fillStyle = '#FF0000';
        ctx.fillRect(
          food.position.x * this.cellSize + 1,
          food.position.y * this.cellSize + 1,
          this.cellSize - 2,
          this.cellSize - 2
        );
      }
    });
  }
}

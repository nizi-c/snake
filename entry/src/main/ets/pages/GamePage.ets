import router from '@ohos.router';
import { SnakeGame, Direction, Position, FoodType } from '../models/SnakeGame';
import image from '@ohos.multimedia.image';
import preferences from '@ohos.data.preferences';
import { ThemeManager, LightTheme, Theme } from '../models/ThemeManager';
import { MusicManager } from '../models/MusicManager';
import { AchievementManager } from '../models/AchievementManager';

interface FoodImageConfig {
  type: FoodType;
  file: string;
}

interface GameRecord {
  score: number;
  time: string;
  character: string;
  mode: string;
  timestamp: number;
}

@Entry
@Component
struct GamePage {
  @State game: SnakeGame = new SnakeGame(200);
  @State isPlaying: boolean = false;
  @State isPaused: boolean = false;
  @State gameMode: string = 'casual';
  @State updateFlag: number = 0;
  @State currentTime: string = '00:00';
  @State controlMode: string = 'click'; // 'button' æˆ– 'click'ï¼Œé»˜è®¤ä¸ºç‚¹å‡»æ§åˆ¶
  @State showControlDialog: boolean = false;
  @State showMenuDialog: boolean = false;
  @State showCharacterDialog: boolean = false;
  @State showChallengeSuccessDialog: boolean = false;
  @State showRulesDialog: boolean = false;
  @State showUnlockDialog: boolean = false;
  @State unlockedCharacterName: string = '';
  @State showAchievementDialog: boolean = false;
  @State unlockedAchievementName: string = '';
  @State dialogSize: number = 300;
  @State currentCharacter: string = 'cat'; // å½“å‰è§’è‰²ï¼šcat, dog, rabbit, hamster
  @State currentTheme: Theme = LightTheme;
  @State bgImagePath: string = '';
  @State isMusicPlaying: boolean = false;
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private musicManager: MusicManager = MusicManager.getInstance();
  private achievementManager: AchievementManager = AchievementManager.getInstance();
  private hasShownSuccessDialog: boolean = false; // æ ‡è®°æ˜¯å¦å·²æ˜¾ç¤ºæˆåŠŸå¼¹çª—
  private totalFoodsCollected: number = 0; // ç´¯è®¡æ”¶é›†çš„é£Ÿç‰©æ•°
  private timerId: number = -1;
  private cellSize: number = 30;
  private canvasContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(new RenderingContextSettings(true));
  private foodImages: Map<FoodType, image.PixelMap> = new Map();
  private cartImage: image.PixelMap | null = null;
  private catImage: image.PixelMap | null = null;

  async aboutToAppear() {
    await this.themeManager.loadTheme(getContext(this));
    this.currentTheme = this.themeManager.getTheme();
    
    // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
    this.updateBackgroundImage();
    
    // åŠ è½½æ§åˆ¶æ–¹å¼
    await this.loadControlMode();
    
    // è·å–éŸ³ä¹çŠ¶æ€
    this.isMusicPlaying = this.musicManager.isPlayingMusic();
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    this.themeManager.addListener((theme: Theme) => {
      this.currentTheme = theme;
      this.updateBackgroundImage();
    });
    
    // ç›‘å¬éŸ³ä¹çŠ¶æ€å˜åŒ–
    this.musicManager.addListener((isPlaying: boolean) => {
      this.isMusicPlaying = isPlaying;
    });
    
    // ç›‘å¬æˆå°±è§£é”
    this.achievementManager.addListener((achievementId: string, name: string) => {
      this.unlockedAchievementName = name;
      this.showAchievementDialog = true;
      
      // 3ç§’åè‡ªåŠ¨éšè—æç¤º
      setTimeout(() => {
        this.showAchievementDialog = false;
      }, 3000);
    });
    
    await this.loadGameSettings();
  }

  async loadControlMode() {
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      this.controlMode = await prefs.get('controlMode', 'click') as string;
      console.info('Loaded control mode:', this.controlMode);
    } catch (err) {
      console.error('Failed to load control mode:', err);
    }
  }

  async saveControlMode() {
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      await prefs.put('controlMode', this.controlMode);
      await prefs.flush();
      console.info('Control mode saved:', this.controlMode);
    } catch (err) {
      console.error('Failed to save control mode:', err);
    }
  }

  toggleMusic() {
    this.musicManager.toggle();
  }

  updateBackgroundImage() {
    // ä¼‘é—²æ¨¡å¼å’ŒæŒ‘æˆ˜æ¨¡å¼éƒ½æ˜¾ç¤ºèƒŒæ™¯å›¾ç‰‡
    this.bgImagePath = this.currentTheme.name === 'light' ? 'light.png' : 'dark.png';
    console.info(`Game background image path set to: ${this.bgImagePath}`);
  }

  aboutToDisappear() {
    // æ¸…ç†ç›‘å¬å™¨
    this.themeManager.removeListener((theme: Theme) => {
      this.currentTheme = theme;
    });
    // åœæ­¢æ¸¸æˆ
    this.stopGame();
  }

  onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½
    const params = router.getParams() as Record<string, Object>;
    if (params?.reload) {
      this.loadGameSettings();
    }
  }

  async loadGameSettings() {
    const params = router.getParams() as Record<string, Object>;
    this.gameMode = (params?.mode as string) || 'casual';
    
    // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
    this.updateBackgroundImage();
    
    let baseSpeed = this.gameMode === 'challenge' ? 100 : 200;
    let gridWidth = 22;
    let gridHeight = 15;
    let characterImage = 'xiaomao.jpg';
    
    // æŒ‘æˆ˜æ¨¡å¼å‚æ•°
    const isChallengeMode = this.gameMode === 'challenge';
    const timeLimit = (params?.timeLimit as number) || 180;
    const targetScore = (params?.targetScore as number) || 0;
    
    // æ£€æŸ¥æ˜¯å¦ä»è®¾ç½®é¡µé¢æˆ–è§’è‰²é€‰æ‹©é¡µé¢è¿”å›
    if (params?.reload) {
      if (params?.gridWidth) {
        gridWidth = params.gridWidth as number;
      }
      if (params?.gridHeight) {
        gridHeight = params.gridHeight as number;
      }
      if (params?.baseSpeed) {
        baseSpeed = params.baseSpeed as number;
      }
      if (params?.character) {
        characterImage = params.character as string;
      }
      console.info('Reloading game with new settings - gridWidth:', gridWidth, 'gridHeight:', gridHeight, 'baseSpeed:', baseSpeed, 'character:', characterImage);
      
      // å…ˆåŠ è½½è§’è‰²å›¾ç‰‡ï¼Œå†åˆ›å»ºæ¸¸æˆå’Œç»˜åˆ¶
      await this.loadCharacterImage(characterImage);
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage, isChallengeMode, timeLimit, targetScore);
      this.stopGame();
      this.drawGame();
      return;
    }
    
    // åŠ è½½è®¾ç½®
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      gridWidth = await prefs.get('gridWidth', 22) as number;
      gridHeight = await prefs.get('gridHeight', 15) as number;
      characterImage = await prefs.get('character', 'xiaomao.jpg') as string;
      
      console.info('Loaded character from preferences:', characterImage);
      
      // åªåœ¨ä¼‘é—²æ¨¡å¼ä½¿ç”¨è‡ªå®šä¹‰é€Ÿåº¦ï¼ŒæŒ‘æˆ˜æ¨¡å¼å›ºå®šä¸º100ms
      if (this.gameMode === 'casual') {
        baseSpeed = await prefs.get('baseSpeed', 200) as number;
      }
      
      // åŠ è½½è§’è‰²å›¾ç‰‡
      await this.loadCharacterImage(characterImage);
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage, isChallengeMode, timeLimit, targetScore);
      console.info('Game created with character:', characterImage);
    } catch (err) {
      console.error('Failed to load settings:', err);
      await this.loadCharacterImage(characterImage);
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage, isChallengeMode, timeLimit, targetScore);
    }
  }

  async loadCharacterImage(characterFile: string) {
    try {
      const context = getContext(this);
      const resourceMgr = context.resourceManager;
      const catData = await resourceMgr.getRawFileContent(characterFile);
      const catSource = image.createImageSource(catData.buffer);
      this.catImage = await catSource.createPixelMap();
      console.info(`${characterFile} loaded successfully`);
    } catch (err) {
      console.error(`Failed to load ${characterFile}:`, JSON.stringify(err));
    }
  }

  async loadFruitImage() {
    try {
      const context = getContext(this);
      const resourceMgr = context.resourceManager;
      
      // åŠ è½½æ‰€æœ‰é£Ÿç‰©å›¾ç‰‡
      const foodFiles: FoodImageConfig[] = [
        { type: FoodType.FRUIT, file: 'fruit.png' } as FoodImageConfig,
        { type: FoodType.ORANGE, file: 'orange.png' } as FoodImageConfig,
        { type: FoodType.WATERMELON, file: 'watermelon.png' } as FoodImageConfig,
        { type: FoodType.MUSHROOM, file: 'mushroom.png' } as FoodImageConfig,
        { type: FoodType.LEMON, file: 'lemon.png' } as FoodImageConfig,
        { type: FoodType.FLOWER, file: 'flower.png' } as FoodImageConfig
      ];
      
      for (const food of foodFiles) {
        try {
          const fileData = await resourceMgr.getRawFileContent(food.file);
          const imageSource = image.createImageSource(fileData.buffer);
          const pixelMap = await imageSource.createPixelMap();
          this.foodImages.set(food.type, pixelMap);
          console.info(`${food.file} loaded successfully`);
        } catch (err) {
          console.error(`Failed to load ${food.file}:`, JSON.stringify(err));
        }
      }
      
      // åŠ è½½è›‡èº«å›¾ç‰‡
      try {
        const cartData = await resourceMgr.getRawFileContent('cart.png');
        const cartSource = image.createImageSource(cartData.buffer);
        this.cartImage = await cartSource.createPixelMap();
        console.info('cart.png loaded successfully');
      } catch (err) {
        console.error('Failed to load cart.png:', JSON.stringify(err));
      }
      
      // åŠ è½½è›‡å¤´å›¾ç‰‡ï¼ˆæ ¹æ®å½“å‰æ¸¸æˆè§’è‰²ï¼‰
      const characterFile = this.game.getCharacter();
      try {
        const catData = await resourceMgr.getRawFileContent(characterFile);
        const catSource = image.createImageSource(catData.buffer);
        this.catImage = await catSource.createPixelMap();
        console.info(`${characterFile} loaded successfully in loadFruitImage`);
      } catch (err) {
        console.error(`Failed to load ${characterFile}:`, JSON.stringify(err));
      }
      
      this.drawGame();
    } catch (err) {
      console.error('Failed to load images:', JSON.stringify(err));
    }
  }

  startGame() {
    if (this.game.isOver()) {
      this.game.init();
    }
    this.game.startTimer();
    this.isPlaying = true;
    this.isPaused = false;
    this.gameLoop();
  }

  stopGame() {
    this.isPlaying = false;
    this.isPaused = false;
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
  }

  async saveGameRecord() {
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      const historyStr = await prefs.get('gameHistory', '[]') as string;
      const history: GameRecord[] = JSON.parse(historyStr) as GameRecord[];

      const record: GameRecord = {
        score: this.game.getScore(),
        time: this.game.getFormattedTime(),
        character: this.game.getCharacter(),
        mode: this.gameMode,
        timestamp: Date.now()
      };

      history.push(record);
      // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
      if (history.length > 50) {
        history.shift();
      }

      await prefs.put('gameHistory', JSON.stringify(history));
      
      // å¢åŠ æ€»æ¸¸æˆæ¬¡æ•°å¹¶æ£€æŸ¥è§’è‰²è§£é”
      const totalGames = await prefs.get('totalGames', 0) as number;
      const newTotalGames = totalGames + 1;
      await prefs.put('totalGames', newTotalGames);
      
      // æ£€æŸ¥æ˜¯å¦è§£é”æ–°è§’è‰²
      this.checkCharacterUnlock(totalGames, newTotalGames);
      
      // æ£€æŸ¥æˆå°±
      await this.checkAchievements(record);
      
      await prefs.flush();
      console.info('Game record saved:', record, 'Total games:', newTotalGames);
    } catch (err) {
      console.error('Failed to save game record:', err);
    }
  }

  async checkAchievements(record: GameRecord) {
    // åˆæ¬¡é‚‚é€…ï¼šå®Œæˆç¬¬ä¸€å±€æ¸¸æˆ
    await this.achievementManager.unlockAchievement('first_game', 'åˆæ¬¡é‚‚é€…');
    
    // åˆ†æ•°ç‹‚äººï¼šä¼‘é—²æ¨¡å¼å•å±€å¾—åˆ†çªç ´5000åˆ†
    if (record.mode === 'casual' && record.score >= 5000) {
      await this.achievementManager.unlockAchievement('score_maniac', 'åˆ†æ•°ç‹‚äºº');
    }
    
    // ç”Ÿå­˜å¤§å¸ˆï¼šä¼‘é—²æ¨¡å¼å­˜æ´»è¶…è¿‡5åˆ†é’Ÿ
    if (record.mode === 'casual') {
      const survivalSeconds = this.game.getSurvivalTime();
      if (survivalSeconds >= 300) {
        await this.achievementManager.unlockAchievement('survival_master', 'ç”Ÿå­˜å¤§å¸ˆ');
      }
    }
    
    // ç¾é£Ÿå¯ç¨‹ï¼šç´¯è®¡æ”¶é›†6ä¸ªé£Ÿç‰©
    await this.checkFoodCollectorAchievement();
  }

  async checkFoodCollectorAchievement() {
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      
      // è·å–ç´¯è®¡é£Ÿç‰©æ•°
      const totalFoods = await prefs.get('totalFoodsCollected', 0) as number;
      const currentGameFoods = this.game.getTotalFoodsEaten();
      const newTotal = totalFoods + currentGameFoods;
      
      await prefs.put('totalFoodsCollected', newTotal);
      await prefs.flush();
      
      console.info('Total foods collected:', newTotal);
      
      if (newTotal >= 6) {
        await this.achievementManager.unlockAchievement('food_collector', 'ç¾é£Ÿå¯ç¨‹');
      }
    } catch (err) {
      console.error('Failed to check food collector achievement:', err);
    }
  }

  async checkQuickEaterAchievement() {
    // æ£€æŸ¥æœ€ååƒæ‰çš„é£Ÿç‰©æ˜¯å¦åœ¨3ç§’å†…
    if (this.game.wasLastFoodEatenQuickly()) {
      await this.achievementManager.unlockAchievement('quick_eater', 'è´ªåƒé¬¼');
      console.info('Quick eater achievement unlocked!');
    }
  }

  checkCharacterUnlock(oldGames: number, newGames: number) {
    const unlockMap: Record<number, string> = {
      2: 'å°ç‹—',
      5: 'å…”å­',
      8: 'ä»“é¼ '
    };

    // æ£€æŸ¥æ˜¯å¦åˆšå¥½è¾¾åˆ°è§£é”æ¡ä»¶
    if (unlockMap[newGames]) {
      this.unlockedCharacterName = unlockMap[newGames];
      this.showUnlockDialog = true;
      console.info('Character unlocked:', this.unlockedCharacterName);
      
      // 3ç§’åè‡ªåŠ¨éšè—æç¤º
      setTimeout(() => {
        this.showUnlockDialog = false;
      }, 3000);
    }
  }

  async saveChallengeRecord() {
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      const params = router.getParams() as Record<string, Object>;
      const levelId = (params?.levelId as number) || 1;
      
      // è·å–å½“å‰å…³å¡çš„æœ€ä½³ç”¨æ—¶
      const recordsStr = await prefs.get('challengeRecords', '{}') as string;
      const records = JSON.parse(recordsStr) as Record<number, number>;
      
      // è®¡ç®—ç”¨æ—¶ï¼ˆç§’ï¼‰
      const usedTime = this.game.getTargetScore() > 0 ? 
        (this.game.getTimeLimit() - this.game.getRemainingTime()) : 0;
      
      // æ›´æ–°æœ€ä½³ç”¨æ—¶ï¼ˆå¦‚æœæ›´å¿«æˆ–é¦–æ¬¡å®Œæˆï¼‰
      if (!records[levelId] || usedTime < records[levelId]) {
        records[levelId] = usedTime;
      }
      
      await prefs.put('challengeRecords', JSON.stringify(records));
      
      // è§£é”ä¸‹ä¸€å…³
      const unlockedLevel = await prefs.get('unlockedLevel', 1) as number;
      if (levelId >= unlockedLevel) {
        await prefs.put('unlockedLevel', levelId + 1);
      }
      
      // æ£€æŸ¥æŒ‘æˆ˜æ¨¡å¼æˆå°±
      await this.checkChallengeAchievements();
      
      await prefs.flush();
      console.info('Challenge record saved - Level:', levelId, 'Time:', usedTime);
    } catch (err) {
      console.error('Failed to save challenge record:', err);
    }
  }

  async checkChallengeAchievements() {
    const remainingTime = this.game.getRemainingTime();
    const lives = this.game.getLives();
    
    // æ—¶é—´ç®¡ç†å¤§å¸ˆï¼šå‰©ä½™è¶…è¿‡1åˆ†é’Ÿå®Œæˆç›®æ ‡
    if (remainingTime > 60) {
      await this.achievementManager.unlockAchievement('time_master', 'æ—¶é—´ç®¡ç†å¤§å¸ˆ');
    }
    
    // æ— ä¼¤æŒ‘æˆ˜è€…ï¼šä¸æ¶ˆè€—ç”Ÿå‘½é€šå…³
    if (lives === 3) {
      await this.achievementManager.unlockAchievement('no_damage', 'æ— ä¼¤æŒ‘æˆ˜è€…');
    }
    
    // æœ€åä¸€ç§’ï¼šå€’è®¡æ—¶æœ€å1ç§’å†…è¾¾æˆç›®æ ‡é€šå…³
    if (remainingTime <= 1) {
      await this.achievementManager.unlockAchievement('last_second', 'æœ€åä¸€ç§’');
    }
    
    // æœ€ä½³æ”¶é›†è€…ï¼šè¿ç»­3æ¬¡æŒ‘æˆ˜é€šå…³ä¸”æ¯æ¬¡å‰©ä½™ç”Ÿå‘½â‰¥2
    await this.checkBestCollectorAchievement(lives);
  }

  async checkBestCollectorAchievement(lives: number) {
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      
      if (lives >= 2) {
        const streak = await prefs.get('challengeStreak', 0) as number;
        const newStreak = streak + 1;
        await prefs.put('challengeStreak', newStreak);
        
        if (newStreak >= 3) {
          await this.achievementManager.unlockAchievement('best_collector', 'æœ€ä½³æ”¶é›†è€…');
        }
      } else {
        await prefs.put('challengeStreak', 0);
      }
      
      await prefs.flush();
    } catch (err) {
      console.error('Failed to check best collector achievement:', err);
    }
  }

  pauseGame() {
    this.isPaused = true;
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
  }

  resumeGame() {
    this.isPaused = false;
    this.gameLoop();
  }

  restartGame() {
    this.stopGame();
    this.hasShownSuccessDialog = false;
    this.showChallengeSuccessDialog = false;
    this.game.init();
    this.startGame();
  }

  gameLoop() {
    if (!this.isPlaying || this.isPaused) return;

    const oldFoodCount = this.game.getTotalFoodsEaten();
    const success = this.game.update();
    const newFoodCount = this.game.getTotalFoodsEaten();
    
    // æ£€æŸ¥æ˜¯å¦åƒåˆ°äº†é£Ÿç‰©ï¼ˆè´ªåƒé¬¼æˆå°±ï¼‰
    if (newFoodCount > oldFoodCount) {
      this.checkQuickEaterAchievement();
    }
    
    this.updateFlag++;
    this.currentTime = this.game.getFormattedTime();
    this.drawGame();

    // æŒ‘æˆ˜æ¨¡å¼ï¼šæ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡åˆ†æ•°
    if (this.game.isChallengeGameMode() && !this.hasShownSuccessDialog && 
        this.game.getScore() >= this.game.getTargetScore()) {
      this.hasShownSuccessDialog = true;
      this.showChallengeSuccessDialog = true;
      this.stopGame();
      
      // ä¿å­˜æŒ‘æˆ˜è®°å½•
      this.saveChallengeRecord();
      return;
    }

    if (!success) {
      this.stopGame();
      // æ¸¸æˆç»“æŸæ—¶ä¿å­˜è®°å½•
      this.saveGameRecord();
      return;
    }

    this.timerId = setTimeout(() => {
      this.gameLoop();
    }, this.game.getSpeed());
  }

  handleDirection(dir: Direction) {
    this.game.setDirection(dir);
    if (!this.isPlaying && !this.game.isOver()) {
      this.startGame();
    } else if (this.isPaused) {
      this.resumeGame();
    }
  }

  handleCanvasClick(x: number, y: number) {
    if (this.controlMode !== 'click') return;

    const head = this.game.getSnake()[0];
    const headX = head.x * this.cellSize + this.cellSize / 2;
    const headY = head.y * this.cellSize + this.cellSize / 2;

    const direction = this.game.getDirection();

    // æ ¹æ®å½“å‰æ–¹å‘åˆ¤æ–­å·¦å³
    let isRight = false;
    if (direction === Direction.UP) {
      isRight = x > headX;
    } else if (direction === Direction.DOWN) {
      isRight = x < headX;
    } else if (direction === Direction.LEFT) {
      isRight = y < headY;
    } else if (direction === Direction.RIGHT) {
      isRight = y > headY;
    }

    if (isRight) {
      this.game.turnRight();
    } else {
      this.game.turnLeft();
    }

    if (!this.isPlaying && !this.game.isOver()) {
      this.startGame();
    } else if (this.isPaused) {
      this.resumeGame();
    }
  }

  getSpeedColor(): string {
    const ratio = this.game.getCurrentSpeedRatio();
    if (ratio >= 1.5) return '#FF5722'; // å¾ˆå¿« - çº¢è‰²
    if (ratio >= 1.2) return '#FF9800'; // å¿« - æ©™è‰²
    if (ratio >= 0.8) return '#4CAF50'; // æ­£å¸¸ - ç»¿è‰²
    return '#2196F3'; // æ…¢ - è“è‰²
  }

  getTransparentBg(color: string, opacity: number): string {
    // å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºrgbaæ ¼å¼
    const hex = color.replace('#', '');
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  }

  @Builder
  MenuDialog() {
    Column() {
      Text('èœå•')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.primaryText)
        .margin({ bottom: 20 })

      // è§’è‰²é€‰æ‹©æŒ‰é’®
      Button('è§’è‰²é€‰æ‹©')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.accentColor)
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.stopGame();
          router.pushUrl({
            url: 'pages/CharacterSelectPage'
          });
        })

      // æ§åˆ¶æ–¹å¼æŒ‰é’®
      Button('æ§åˆ¶æ–¹å¼')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.name === 'dark' ? '#D4AF37' : this.currentTheme.buttonPrimary)
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.showControlDialog = true;
        })

      // è®¾ç½®æŒ‰é’®
      if (this.gameMode === 'casual') {
        Button('è®¾ç½®')
          .width('100%')
          .height(50)
          .fontSize(18)
          .fontColor('#FFFFFF')
          .backgroundColor(this.currentTheme.successColor)
          .margin({ bottom: 15 })
          .onClick(() => {
            this.showMenuDialog = false;
            this.stopGame();
            router.pushUrl({
              url: 'pages/SettingsPage'
            });
          })
      }

      // è§„åˆ™ä»‹ç»æŒ‰é’®
      Button('è§„åˆ™ä»‹ç»')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.buttonPrimary)
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.showRulesDialog = true;
        })

      // å†å²è®°å½•æŒ‰é’®
      Button('å†å²è®°å½•')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.warningColor)
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.stopGame();
          router.pushUrl({
            url: 'pages/HistoryPage'
          });
        })

      // å–æ¶ˆæŒ‰é’®
      Button('å–æ¶ˆ')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.buttonSecondary)
        .onClick(() => {
          this.showMenuDialog = false;
        })
    }
    .width('60%')
    .padding(25)
    .backgroundColor(this.currentTheme.secondaryBg)
    .borderRadius(16)
    .shadow({ radius: 10, color: this.currentTheme.shadowColor })
  }

  @Builder
  ControlDialog() {
    Column() {
      Text('é€‰æ‹©æ§åˆ¶æ–¹å¼')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.primaryText)
        .margin({ bottom: 30 })

      // æŒ‰é”®æ§åˆ¶
      Column() {
        Row() {
          Radio({ value: 'button', group: 'controlGroup' })
            .checked(this.controlMode === 'button')
            .onChange((isChecked: boolean) => {
              if (isChecked) {
                this.controlMode = 'button';
              }
            })

          Column() {
            Text('æŒ‰é”®æ§åˆ¶')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 5 })

            Text('ä½¿ç”¨å±å¹•ä¸‹æ–¹çš„æ–¹å‘æŒ‰é’®æ§åˆ¶å°åŠ¨ç‰©çš„ç§»åŠ¨æ–¹å‘')
              .fontSize(14)
              .fontColor(this.currentTheme.secondaryText)
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 10 })
          .layoutWeight(1)
        }
        .width('100%')
        .padding(15)
        .backgroundColor(this.controlMode === 'button' ? this.currentTheme.cardBg : this.currentTheme.borderColor)
        .borderRadius(8)
        .onClick(() => this.controlMode = 'button')
      }
      .width('100%')
      .margin({ bottom: 15 })

      // ç‚¹å‡»æ§åˆ¶
      Column() {
        Row() {
          Radio({ value: 'click', group: 'controlGroup' })
            .checked(this.controlMode === 'click')
            .onChange((isChecked: boolean) => {
              if (isChecked) {
                this.controlMode = 'click';
              }
            })

          Column() {
            Text('ç‚¹å‡»æ§åˆ¶')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 5 })

            Text('ç‚¹å‡»æ¸¸æˆåŒºåŸŸï¼šå°åŠ¨ç‰©å³ä¾§å³è½¬ï¼Œå·¦ä¾§å·¦è½¬')
              .fontSize(14)
              .fontColor(this.currentTheme.secondaryText)
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 10 })
          .layoutWeight(1)
        }
        .width('100%')
        .padding(15)
        .backgroundColor(this.controlMode === 'click' ? this.currentTheme.cardBg : this.currentTheme.borderColor)
        .borderRadius(8)
        .onClick(() => this.controlMode = 'click')
      }
      .width('100%')
      .margin({ bottom: 30 })

      Button('ç¡®å®š')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.buttonPrimary)
        .onClick(() => {
          this.showControlDialog = false;
          this.saveControlMode();
        })
    }
    .width(this.dialogSize)
    .height(this.dialogSize)
    .padding(25)
    .backgroundColor(this.currentTheme.secondaryBg)
    .borderRadius(16)
    .justifyContent(FlexAlign.Center)
    .shadow({ radius: 10, color: this.currentTheme.shadowColor })
    .onAreaChange((oldValue: Area, newValue: Area) => {
      // å½“åŒºåŸŸæ”¹å˜æ—¶ï¼Œç¡®ä¿ä¿æŒæ­£æ–¹å½¢
      const width = newValue.width as number;
      this.dialogSize = Math.min(width, 400);
    })
  }

  @Builder
  RulesDialog() {
    Column() {
      Text('ä¼‘é—²æ¨¡å¼è§„åˆ™')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.primaryText)
        .margin({ bottom: 20 })

      Scroll() {
        Column() {
          Text('ğŸ® æ¸¸æˆç›®æ ‡')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTheme.primaryText)
            .margin({ bottom: 10 })
            .width('100%')

          Text('æ§åˆ¶å°åŠ¨ç‰©æ”¶é›†é£Ÿç‰©ï¼Œè·å¾—å°½å¯èƒ½é«˜çš„åˆ†æ•°å’Œå­˜æ´»æ—¶é—´ã€‚')
            .fontSize(14)
            .fontColor(this.currentTheme.secondaryText)
            .lineHeight(22)
            .margin({ bottom: 15 })

          Text('ğŸ é£Ÿç‰©ç³»ç»Ÿ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTheme.primaryText)
            .margin({ bottom: 10 })
            .width('100%')

          Text('â€¢ è‹¹æœï¼š+10åˆ†\nâ€¢ æ©™å­ï¼š+20åˆ†\nâ€¢ è¥¿ç“œï¼š+30åˆ†\nâ€¢ æŸ æª¬ï¼šé€Ÿåº¦-10%\nâ€¢ èŠ±æœµï¼šé€Ÿåº¦+10%\nâ€¢ è˜‘è‡ï¼š-20åˆ†')
            .fontSize(14)
            .fontColor(this.currentTheme.secondaryText)
            .lineHeight(22)
            .margin({ bottom: 15 })

          Text('ğŸ± è§’è‰²ç‰¹æ€§')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTheme.primaryText)
            .margin({ bottom: 10 })
            .width('100%')

          Text('â€¢ å°çŒ«ï¼šå…ç–«3æ¬¡è˜‘è‡æ‰£åˆ†\nâ€¢ å°ç‹—ï¼šé€Ÿåº¦+10%ï¼Œåˆ†æ•°æ•ˆæœÃ—2\nâ€¢ å…”å­ï¼šé€Ÿåº¦å˜åŒ–Ã—2ï¼Œåˆ†æ•°æ•ˆæœ+50%\nâ€¢ ä»“é¼ ï¼šåˆå§‹100åˆ†ï¼Œé€Ÿåº¦-10%ï¼Œå‡åˆ†+200%')
            .fontSize(14)
            .fontColor(this.currentTheme.secondaryText)
            .lineHeight(22)
            .margin({ bottom: 15 })

          Text('âš¡ é€Ÿåº¦æœºåˆ¶')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTheme.primaryText)
            .margin({ bottom: 10 })
            .width('100%')

          Text('æ¯è·å¾—50åˆ†ï¼Œé€Ÿåº¦è‡ªåŠ¨æå‡10%ï¼Œå¢åŠ æŒ‘æˆ˜éš¾åº¦ã€‚')
            .fontSize(14)
            .fontColor(this.currentTheme.secondaryText)
            .lineHeight(22)
        }
        .width('100%')
      }
      .layoutWeight(1)
      .width('100%')

      Button('çŸ¥é“äº†')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.buttonPrimary)
        .margin({ top: 15 })
        .onClick(() => {
          this.showRulesDialog = false;
        })
    }
    .width('85%')
    .height('70%')
    .padding(25)
    .backgroundColor(this.currentTheme.secondaryBg)
    .borderRadius(16)
    .shadow({ radius: 10, color: this.currentTheme.shadowColor })
  }

  build() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡ï¼ˆä»…ä¼‘é—²æ¨¡å¼ï¼‰- æ”¾åœ¨æœ€å¤–å±‚å æ»¡æ•´ä¸ªé¡µé¢
      if (this.bgImagePath) {
        Image($rawfile(this.bgImagePath))
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
      }

      Column() {
        // é¡¶éƒ¨ä¿¡æ¯æ 
        Column() {
          Row() {
            Button('è¿”å›')
              .fontSize(16)
              .backgroundColor(this.currentTheme.buttonSecondary)
              .fontColor('#FFFFFF')
              .onClick(() => {
                this.stopGame();
                router.back();
              })

            Row() {
              Text(`${this.gameMode === 'casual' ? 'ä¼‘é—²æ¨¡å¼' : 'æŒ‘æˆ˜æ¨¡å¼'}`)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.currentTheme.primaryText)
            }
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)

            Row() {
              Column() {
                if (this.game.isChallengeGameMode()) {
                  // æŒ‘æˆ˜æ¨¡å¼ï¼šæ˜¾ç¤ºç”Ÿå‘½å’Œç›®æ ‡åˆ†æ•°
                  Row() {
                    Image($rawfile('heart.png'))
                      .width(20)
                      .height(20)
                      .margin({ right: 5 })
                    
                    Text(`Ã— ${this.game.getLives()}`)
                      .fontSize(18)
                      .fontWeight(FontWeight.Bold)
                      .fontColor(this.currentTheme.dangerColor)
                      .margin({ right: 10 })
                    
                    Text(`${this.game.getScore()}/${this.game.getTargetScore()}`)
                      .fontSize(18)
                      .fontWeight(FontWeight.Medium)
                      .fontColor(this.currentTheme.name === 'dark' ? this.currentTheme.accentColor : this.currentTheme.primaryText)
                  }
                  
                  Text(`é€Ÿåº¦: ${this.game.getCurrentSpeedRatio().toFixed(1)}x`)
                    .fontSize(14)
                    .fontColor(this.getSpeedColor())
                } else {
                  // ä¼‘é—²æ¨¡å¼ï¼šæ˜¾ç¤ºå¾—åˆ†å’Œé€Ÿåº¦
                  Text(`å¾—åˆ†: ${this.game.getScore()}`)
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(this.currentTheme.name === 'dark' ? this.currentTheme.accentColor : this.currentTheme.primaryText)
                  
                  Text(`é€Ÿåº¦: ${this.game.getCurrentSpeedRatio().toFixed(1)}x`)
                    .fontSize(14)
                    .fontColor(this.getSpeedColor())
                }
              }
              .alignItems(HorizontalAlign.End)
              .margin({ right: 10 })

              Button('â‹®')
                .fontSize(24)
                .width(40)
                .height(40)
                .backgroundColor(this.currentTheme.borderColor)
                .fontColor(this.currentTheme.primaryText)
                .onClick(() => {
                  this.showMenuDialog = true;
                })
            }
          }
          .width('100%')
          .height(50)
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 20, right: 20 })

          // ç¬¬äºŒè¡Œï¼šæ—¶é—´ã€é€Ÿåº¦å’Œæ§åˆ¶æŒ‰é’®
          Row() {
            Row() {
              if (this.game.isChallengeGameMode()) {
                // æŒ‘æˆ˜æ¨¡å¼ï¼šæ˜¾ç¤ºå€’è®¡æ—¶
                Text(`â±ï¸ ${this.game.getFormattedRemainingTime()}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.game.getRemainingTime() <= 30 ? this.currentTheme.dangerColor : 
                            (this.currentTheme.name === 'dark' ? this.currentTheme.accentColor : this.currentTheme.secondaryText))
                
                // å°çŒ«è§’è‰²æ˜¾ç¤ºå…ç–«æ¬¡æ•°
                if ((this.game.getCharacter() === 'xiaomao.jpg' || this.game.getCharacter() === 'xiaom.jpg' || this.game.getCharacter() === 'cat.png') && this.game.getMushroomImmunity() > 0) {
                  Row() {
                    Text(' | ')
                      .fontSize(16)
                      .fontColor(this.currentTheme.accentColor)
                    
                    Image($rawfile('dunpai.png'))
                      .width(30)
                      .height(30)
                      .margin({ right: 3 })
                    
                    Text(`Ã—${this.game.getMushroomImmunity()}`)
                      .fontSize(16)
                      .fontColor(this.currentTheme.accentColor)
                  }
                }
              } else {
                // ä¼‘é—²æ¨¡å¼ï¼šæ˜¾ç¤ºå­˜æ´»æ—¶é—´
                Text(`æ—¶é—´: ${this.currentTime}`)
                  .fontSize(16)
                  .fontColor(this.currentTheme.name === 'dark' ? this.currentTheme.accentColor : this.currentTheme.secondaryText)
                
                if ((this.game.getCharacter() === 'xiaomao.jpg' || this.game.getCharacter() === 'xiaom.jpg' || this.game.getCharacter() === 'cat.png') && this.game.getMushroomImmunity() > 0) {
                  Row() {
                    Text(' | ')
                      .fontSize(16)
                      .fontColor(this.currentTheme.accentColor)
                    
                    Image($rawfile('dunpai.png'))
                      .width(30)
                      .height(30)
                      .margin({ right: 3 })
                    
                    Text(`Ã—${this.game.getMushroomImmunity()}`)
                      .fontSize(16)
                      .fontColor(this.currentTheme.accentColor)
                  }
                }
              }
            }

            // ä¼‘é—²æ¨¡å¼å’ŒæŒ‘æˆ˜æ¨¡å¼éƒ½æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
            Row() {
              Row() {
                if (!this.isPlaying || this.game.isOver()) {
                  Button('å¼€å§‹')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor(this.currentTheme.successColor)
                    .fontColor('#FFFFFF')
                    .onClick(() => this.startGame())
                } else if (this.isPaused) {
                  Button('ç»§ç»­')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor(this.currentTheme.successColor)
                    .fontColor('#FFFFFF')
                    .onClick(() => this.resumeGame())
                } else {
                  Button('æš‚åœ')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor(this.currentTheme.accentColor)
                    .fontColor('#FFFFFF')
                    .onClick(() => this.pauseGame())
                }

                Button('é‡å¼€')
                  .fontSize(14)
                  .height(32)
                  .backgroundColor(this.currentTheme.buttonPrimary)
                  .fontColor('#FFFFFF')
                  .margin({ left: 10 })
                  .onClick(() => this.restartGame())
              }

              Image($rawfile(this.isMusicPlaying ? 'bofang.png' : 'bofang_n.png'))
                .width(32)
                .height(32)
                .onClick(() => this.toggleMusic())
            }
          }
          .width('100%')
          .height(40)
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 20, right: 20 })
        }
        .width('100%')
        .backgroundColor(this.getTransparentBg(this.currentTheme.secondaryBg, 0.6))

        // æ¸¸æˆåŒºåŸŸ
        Column() {
          Canvas(this.canvasContext)
            .width(this.game.getGridWidth() * this.cellSize)
            .height(this.game.getGridHeight() * this.cellSize)
            .backgroundColor('rgba(255, 255, 255, 0.3)')
            .onReady(() => {
              this.loadFruitImage();
              this.drawGame();
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Down) {
                this.handleCanvasClick(event.touches[0].x, event.touches[0].y);
              }
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('rgba(0, 0, 0, 0)')

        // æ¸¸æˆç»“æŸæç¤º
        if (this.game.isOver()) {
          Column() {
            Image($rawfile('success.jpg'))
              .width(200)
              .height(200)
              .margin({ bottom: 20 })

            Text('æ¸¸æˆç»“æŸ!')
              .fontSize(32)
              .fontColor(this.currentTheme.name === 'dark' ? '#FFFFFF' : this.currentTheme.accentColor)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })

            Text(`å¾—åˆ†: ${this.game.getScore()}`)
              .fontSize(20)
              .fontColor(this.currentTheme.primaryText)
              .margin({ bottom: 10 })

            Text(`å­˜æ´»æ—¶é—´: ${this.currentTime}`)
              .fontSize(16)
              .fontColor(this.currentTheme.secondaryText)
              .margin({ bottom: 25 })

            Button('é‡æ–°å¼€å§‹')
              .fontSize(18)
              .width(160)
              .height(50)
              .fontColor('#FFFFFF')
              .backgroundColor(this.currentTheme.successColor)
              .onClick(() => {
                this.restartGame();
              })
          }
          .width(320)
          .padding(20)
          .backgroundColor(this.currentTheme.secondaryBg)
          .borderRadius(16)
          .shadow({ radius: 20, color: this.currentTheme.shadowColor })
          .position({ x: '50%', y: '40%' })
          .translate({ x: '-50%', y: '-50%' })
        }

        // æš‚åœæç¤º
        if (this.isPaused && !this.game.isOver()) {
          Column() {
            Image($rawfile('stop.png'))
              .width(200)
              .height(200)
              .margin({ bottom: 20 })

            Text('æ¸¸æˆå·²æš‚åœ')
              .fontSize(32)
              .fontColor(this.currentTheme.name === 'dark' ? '#FFFFFF' : this.currentTheme.accentColor)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })

            Text('ç‚¹å‡»"ç»§ç»­"æˆ–æ–¹å‘é”®æ¢å¤æ¸¸æˆ')
              .fontSize(16)
              .fontColor(this.currentTheme.secondaryText)
          }
          .width(320)
          .padding(20)
          .backgroundColor(this.currentTheme.secondaryBg)
          .borderRadius(16)
          .shadow({ radius: 20, color: this.currentTheme.shadowColor })
          .position({ x: '50%', y: '40%' })
          .translate({ x: '-50%', y: '-50%' })
        }

        // æŒ‘æˆ˜æˆåŠŸæç¤º
        if (this.showChallengeSuccessDialog) {
          Column() {
            Image($rawfile('success3.png'))
              .width(200)
              .height(200)
              .margin({ bottom: 20 })

            Text('æŒ‘æˆ˜æˆåŠŸ')
              .fontSize(32)
              .fontColor(this.currentTheme.name === 'dark' ? '#FFFFFF' : this.currentTheme.accentColor)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })

            Text('æˆåŠŸå¸®åŠ©å°åŠ¨ç‰©æ”¶é›†é£Ÿç‰©')
              .fontSize(16)
              .fontColor(this.currentTheme.secondaryText)
              .margin({ bottom: 10 })

            Text('ç‚¹å‡»è¿”å›å…³å¡é¡µé¢')
              .fontSize(14)
              .fontColor(this.currentTheme.hintText)
          }
          .width(320)
          .padding(20)
          .backgroundColor(this.currentTheme.secondaryBg)
          .borderRadius(16)
          .shadow({ radius: 20, color: this.currentTheme.shadowColor })
          .position({ x: '50%', y: '40%' })
          .translate({ x: '-50%', y: '-50%' })
          .onClick(() => {
            router.back();
          })
        }

        // è§’è‰²è§£é”æç¤ºï¼ˆé¡¶éƒ¨æ¶ˆæ¯é€šçŸ¥ï¼‰
        if (this.showUnlockDialog) {
          Row() {
            Image($rawfile('star.png'))
              .width(40)
              .height(40)
              .margin({ right: 12 })

            Column() {
              Text('ğŸ‰ æ­å–œè§£é”æ–°è§’è‰²')
                .fontSize(16)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 4 })

              Text(`${this.unlockedCharacterName}å·²è§£é”ï¼Œå¿«å»è¯•è¯•å§ï¼`)
                .fontSize(14)
                .fontColor('#FFFFFF')
                .opacity(0.9)
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
          }
          .width('90%')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor('#FF9800')
          .borderRadius(12)
          .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.3)' })
          .position({ x: '50%', y: 60 })
          .translate({ x: '-50%', y: 0 })
          .animation({
            duration: 300,
            curve: Curve.EaseOut
          })
        }

        // æˆå°±è§£é”æç¤ºï¼ˆé¡¶éƒ¨æ¶ˆæ¯é€šçŸ¥ï¼‰
        if (this.showAchievementDialog) {
          Row() {
            Image($rawfile('award.png'))
              .width(40)
              .height(40)
              .margin({ right: 12 })

            Column() {
              Text('ğŸ‰ æˆå°±è§£é”')
                .fontSize(16)
                .fontColor('#FFFFFF')
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 4 })

              Text(`æ­å–œè·å¾—ã€Œ${this.unlockedAchievementName}ã€æˆå°±ï¼`)
                .fontSize(14)
                .fontColor('#FFFFFF')
                .opacity(0.9)
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
          }
          .width('90%')
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .backgroundColor('#4CAF50')
          .borderRadius(12)
          .shadow({ radius: 8, color: 'rgba(0, 0, 0, 0.3)' })
          .position({ x: '50%', y: this.showUnlockDialog ? 120 : 60 })
          .translate({ x: '-50%', y: 0 })
          .animation({
            duration: 300,
            curve: Curve.EaseOut
          })
        }

        // æ§åˆ¶æŒ‰é’®ï¼ˆä»…åœ¨æŒ‰é”®æ¨¡å¼æ˜¾ç¤ºï¼‰
        if (this.controlMode === 'button') {
          Column() {
            Row() {
              Button('â†‘')
                .width(80)
                .height(80)
                .fontSize(32)
                .fontColor(this.currentTheme.primaryText)
                .backgroundColor('rgba(0, 0, 0, 0)')
                .border({ width: 2, color: this.currentTheme.buttonPrimary })
                .onClick(() => this.handleDirection(Direction.UP))
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 10 })

            Row() {
              Button('â†')
                .width(80)
                .height(80)
                .fontSize(32)
                .fontColor(this.currentTheme.primaryText)
                .backgroundColor('rgba(0, 0, 0, 0)')
                .border({ width: 2, color: this.currentTheme.buttonPrimary })
                .margin({ right: 10 })
                .onClick(() => this.handleDirection(Direction.LEFT))

              Button('â†“')
                .width(80)
                .height(80)
                .fontSize(32)
                .fontColor(this.currentTheme.primaryText)
                .backgroundColor('rgba(0, 0, 0, 0)')
                .border({ width: 2, color: this.currentTheme.buttonPrimary })
                .margin({ right: 10 })
                .onClick(() => this.handleDirection(Direction.DOWN))

              Button('â†’')
                .width(80)
                .height(80)
                .fontSize(32)
                .fontColor(this.currentTheme.primaryText)
                .backgroundColor('rgba(0, 0, 0, 0)')
                .border({ width: 2, color: this.currentTheme.buttonPrimary })
                .onClick(() => this.handleDirection(Direction.RIGHT))
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
          }
          .width('100%')
          .padding({ top: 20, bottom: 40 })
          .backgroundColor('rgba(255, 255, 255, 0.1)')
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.bgImagePath ? 'rgba(0, 0, 0, 0)' : this.currentTheme.primaryBg)

      // èœå•å¼¹çª—
      if (this.showMenuDialog) {
        Column() {
          this.MenuDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showMenuDialog = false;
        })
        .onAreaChange((oldValue: Area, newValue: Area) => {
          // æ ¹æ®å±å¹•å®½åº¦è°ƒæ•´å¼¹çª—å¤§å°
          const screenWidth = newValue.width as number;
          this.dialogSize = Math.min(screenWidth * 0.8, 400);
        })
      }

      // æ§åˆ¶æ–¹å¼é€‰æ‹©å¼¹çª—
      if (this.showControlDialog) {
        Column() {
          this.ControlDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showControlDialog = false;
        })
      }

      // è§„åˆ™ä»‹ç»å¼¹çª—
      if (this.showRulesDialog) {
        Column() {
          this.RulesDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showRulesDialog = false;
        })
      }
    }
    .width('100%')
    .height('100%')
  }

  private drawGame() {
    const ctx = this.canvasContext;
    const gridWidth = this.game.getGridWidth();
    const gridHeight = this.game.getGridHeight();

    // æ¸…ç©ºç”»å¸ƒ - ä½¿ç”¨é€æ˜èƒŒæ™¯
    ctx.clearRect(0, 0, gridWidth * this.cellSize, gridHeight * this.cellSize);

    // ç»˜åˆ¶ç½‘æ ¼çº¿ - æ ¹æ®ä¸»é¢˜è®¾ç½®ç½‘æ ¼çº¿é¢œè‰²
    ctx.strokeStyle = this.currentTheme.name === 'light' ? '#E0E0E0' : '#333333';
    ctx.lineWidth = 1;
    for (let i = 0; i <= gridWidth; i++) {
      ctx.beginPath();
      ctx.moveTo(i * this.cellSize, 0);
      ctx.lineTo(i * this.cellSize, gridHeight * this.cellSize);
      ctx.stroke();
    }
    for (let i = 0; i <= gridHeight; i++) {
      ctx.beginPath();
      ctx.moveTo(0, i * this.cellSize);
      ctx.lineTo(gridWidth * this.cellSize, i * this.cellSize);
      ctx.stroke();
    }

    // ç»˜åˆ¶è›‡
    const snake = this.game.getSnake();
    snake.forEach((segment, index) => {
      if (index === 0) {
        // è›‡å¤´ä½¿ç”¨cat2å›¾ç‰‡
        if (this.catImage) {
          try {
            ctx.drawImage(
              this.catImage,
              segment.x * this.cellSize,
              segment.y * this.cellSize,
              this.cellSize,
              this.cellSize
            );
          } catch (err) {
            console.error('Failed to draw cat image:', err);
            // ç»˜åˆ¶å¤±è´¥æ—¶ä½¿ç”¨ç»¿è‰²æ–¹å—
            ctx.fillStyle = '#00FF00';
            ctx.fillRect(
              segment.x * this.cellSize + 1,
              segment.y * this.cellSize + 1,
              this.cellSize - 2,
              this.cellSize - 2
            );
          }
        } else {
          // å›¾ç‰‡æœªåŠ è½½æ—¶ä½¿ç”¨ç»¿è‰²æ–¹å—
          ctx.fillStyle = '#00FF00';
          ctx.fillRect(
            segment.x * this.cellSize + 1,
            segment.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else if (this.cartImage) {
        // è›‡èº«å’Œè›‡å°¾ä½¿ç”¨cartå›¾ç‰‡
        try {
          ctx.drawImage(
            this.cartImage,
            segment.x * this.cellSize,
            segment.y * this.cellSize,
            this.cellSize,
            this.cellSize
          );
        } catch (err) {
          console.error('Failed to draw cart image:', err);
          // ç»˜åˆ¶å¤±è´¥æ—¶ä½¿ç”¨ç»¿è‰²æ–¹å—
          ctx.fillStyle = '#00CC00';
          ctx.fillRect(
            segment.x * this.cellSize + 1,
            segment.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else {
        // å›¾ç‰‡æœªåŠ è½½æ—¶ä½¿ç”¨ç»¿è‰²æ–¹å—
        ctx.fillStyle = '#00CC00';
        ctx.fillRect(
          segment.x * this.cellSize + 1,
          segment.y * this.cellSize + 1,
          this.cellSize - 2,
          this.cellSize - 2
        );
      }
    });

    // ç»˜åˆ¶é£Ÿç‰©
    const foods = this.game.getFoods();
    
    foods.forEach(food => {
      const foodImage = this.foodImages.get(food.type);
      
      if (foodImage) {
        try {
          ctx.drawImage(
            foodImage,
            food.position.x * this.cellSize,
            food.position.y * this.cellSize,
            this.cellSize,
            this.cellSize
          );
        } catch (err) {
          console.error('Failed to draw food image:', err);
          // ç»˜åˆ¶å¤±è´¥æ—¶ä½¿ç”¨çº¢è‰²æ–¹å—
          ctx.fillStyle = '#FF0000';
          ctx.fillRect(
            food.position.x * this.cellSize + 1,
            food.position.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else {
        // å›¾ç‰‡æœªåŠ è½½æ—¶ä½¿ç”¨çº¢è‰²æ–¹å—
        ctx.fillStyle = '#FF0000';
        ctx.fillRect(
          food.position.x * this.cellSize + 1,
          food.position.y * this.cellSize + 1,
          this.cellSize - 2,
          this.cellSize - 2
        );
      }
    });
  }
}

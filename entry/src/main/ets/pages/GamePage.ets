import router from '@ohos.router';
import { SnakeGame, Direction, Position, FoodType } from '../models/SnakeGame';
import image from '@ohos.multimedia.image';
import preferences from '@ohos.data.preferences';
import { ThemeManager, LightTheme, Theme } from '../models/ThemeManager';

interface FoodImageConfig {
  type: FoodType;
  file: string;
}

interface GameRecord {
  score: number;
  time: string;
  character: string;
  mode: string;
  timestamp: number;
}

@Entry
@Component
struct GamePage {
  @State game: SnakeGame = new SnakeGame(200);
  @State isPlaying: boolean = false;
  @State isPaused: boolean = false;
  @State gameMode: string = 'casual';
  @State updateFlag: number = 0;
  @State currentTime: string = '00:00';
  @State controlMode: string = 'button'; // 'button' æˆ– 'click'
  @State showControlDialog: boolean = false;
  @State showMenuDialog: boolean = false;
  @State showCharacterDialog: boolean = false;
  @State dialogSize: number = 300;
  @State currentCharacter: string = 'cat'; // å½“å‰è§’è‰²ï¼šcat, dog, rabbit, hamster
  @State currentTheme: Theme = LightTheme;
  @State bgImagePath: string = '';
  private themeManager: ThemeManager = ThemeManager.getInstance();
  private timerId: number = -1;
  private cellSize: number = 30;
  private canvasContext: CanvasRenderingContext2D = new CanvasRenderingContext2D(new RenderingContextSettings(true));
  private foodImages: Map<FoodType, image.PixelMap> = new Map();
  private cartImage: image.PixelMap | null = null;
  private catImage: image.PixelMap | null = null;

  async aboutToAppear() {
    await this.themeManager.loadTheme(getContext(this));
    this.currentTheme = this.themeManager.getTheme();
    
    // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
    this.updateBackgroundImage();
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    this.themeManager.addListener((theme: Theme) => {
      this.currentTheme = theme;
      this.updateBackgroundImage();
    });
    
    await this.loadGameSettings();
  }

  updateBackgroundImage() {
    // åªåœ¨ä¼‘é—²æ¨¡å¼æ˜¾ç¤ºèƒŒæ™¯å›¾ç‰‡
    if (this.gameMode === 'casual') {
      this.bgImagePath = this.currentTheme.name === 'light' ? 'light.png' : 'dark.png';
    } else {
      this.bgImagePath = '';
    }
    console.info(`Game background image path set to: ${this.bgImagePath}`);
  }

  aboutToDisappear() {
    // æ¸…ç†ç›‘å¬å™¨
    this.themeManager.removeListener((theme: Theme) => {
      this.currentTheme = theme;
    });
    // åœæ­¢æ¸¸æˆ
    this.stopGame();
  }

  onPageShow() {
    // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½
    const params = router.getParams() as Record<string, Object>;
    if (params?.reload) {
      this.loadGameSettings();
    }
  }

  async loadGameSettings() {
    const params = router.getParams() as Record<string, Object>;
    this.gameMode = (params?.mode as string) || 'casual';
    
    // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
    this.updateBackgroundImage();
    
    let baseSpeed = this.gameMode === 'challenge' ? 100 : 200;
    let gridWidth = 22;
    let gridHeight = 15;
    let characterImage = 'xiaomao.jpg';
    
    // æ£€æŸ¥æ˜¯å¦ä»è®¾ç½®é¡µé¢æˆ–è§’è‰²é€‰æ‹©é¡µé¢è¿”å›
    if (params?.reload) {
      if (params?.gridWidth) {
        gridWidth = params.gridWidth as number;
      }
      if (params?.gridHeight) {
        gridHeight = params.gridHeight as number;
      }
      if (params?.baseSpeed) {
        baseSpeed = params.baseSpeed as number;
      }
      if (params?.character) {
        characterImage = params.character as string;
      }
      console.info('Reloading game with new settings - gridWidth:', gridWidth, 'gridHeight:', gridHeight, 'baseSpeed:', baseSpeed, 'character:', characterImage);
      
      // å…ˆåŠ è½½è§’è‰²å›¾ç‰‡ï¼Œå†åˆ›å»ºæ¸¸æˆå’Œç»˜åˆ¶
      await this.loadCharacterImage(characterImage);
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage);
      this.stopGame();
      this.drawGame();
      return;
    }
    
    // åŠ è½½è®¾ç½®
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      gridWidth = await prefs.get('gridWidth', 22) as number;
      gridHeight = await prefs.get('gridHeight', 15) as number;
      characterImage = await prefs.get('character', 'xiaomao.jpg') as string;
      
      console.info('Loaded character from preferences:', characterImage);
      
      // åªåœ¨ä¼‘é—²æ¨¡å¼ä½¿ç”¨è‡ªå®šä¹‰é€Ÿåº¦ï¼ŒæŒ‘æˆ˜æ¨¡å¼å›ºå®šä¸º100ms
      if (this.gameMode === 'casual') {
        baseSpeed = await prefs.get('baseSpeed', 200) as number;
      }
      
      // åŠ è½½è§’è‰²å›¾ç‰‡
      await this.loadCharacterImage(characterImage);
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage);
      console.info('Game created with character:', characterImage);
    } catch (err) {
      console.error('Failed to load settings:', err);
      await this.loadCharacterImage(characterImage);
      this.game = new SnakeGame(baseSpeed, gridWidth, gridHeight, characterImage);
    }
  }

  async loadCharacterImage(characterFile: string) {
    try {
      const context = getContext(this);
      const resourceMgr = context.resourceManager;
      const catData = await resourceMgr.getRawFileContent(characterFile);
      const catSource = image.createImageSource(catData.buffer);
      this.catImage = await catSource.createPixelMap();
      console.info(`${characterFile} loaded successfully`);
    } catch (err) {
      console.error(`Failed to load ${characterFile}:`, JSON.stringify(err));
    }
  }

  async loadFruitImage() {
    try {
      const context = getContext(this);
      const resourceMgr = context.resourceManager;
      
      // åŠ è½½æ‰€æœ‰é£Ÿç‰©å›¾ç‰‡
      const foodFiles: FoodImageConfig[] = [
        { type: FoodType.FRUIT, file: 'fruit.png' } as FoodImageConfig,
        { type: FoodType.ORANGE, file: 'orange.png' } as FoodImageConfig,
        { type: FoodType.WATERMELON, file: 'watermelon.png' } as FoodImageConfig,
        { type: FoodType.MUSHROOM, file: 'mushroom.png' } as FoodImageConfig,
        { type: FoodType.LEMON, file: 'lemon.png' } as FoodImageConfig,
        { type: FoodType.FLOWER, file: 'flower.png' } as FoodImageConfig
      ];
      
      for (const food of foodFiles) {
        try {
          const fileData = await resourceMgr.getRawFileContent(food.file);
          const imageSource = image.createImageSource(fileData.buffer);
          const pixelMap = await imageSource.createPixelMap();
          this.foodImages.set(food.type, pixelMap);
          console.info(`${food.file} loaded successfully`);
        } catch (err) {
          console.error(`Failed to load ${food.file}:`, JSON.stringify(err));
        }
      }
      
      // åŠ è½½è›‡èº«å›¾ç‰‡
      try {
        const cartData = await resourceMgr.getRawFileContent('cart.png');
        const cartSource = image.createImageSource(cartData.buffer);
        this.cartImage = await cartSource.createPixelMap();
        console.info('cart.png loaded successfully');
      } catch (err) {
        console.error('Failed to load cart.png:', JSON.stringify(err));
      }
      
      // åŠ è½½è›‡å¤´å›¾ç‰‡ï¼ˆæ ¹æ®å½“å‰æ¸¸æˆè§’è‰²ï¼‰
      const characterFile = this.game.getCharacter();
      try {
        const catData = await resourceMgr.getRawFileContent(characterFile);
        const catSource = image.createImageSource(catData.buffer);
        this.catImage = await catSource.createPixelMap();
        console.info(`${characterFile} loaded successfully in loadFruitImage`);
      } catch (err) {
        console.error(`Failed to load ${characterFile}:`, JSON.stringify(err));
      }
      
      this.drawGame();
    } catch (err) {
      console.error('Failed to load images:', JSON.stringify(err));
    }
  }

  startGame() {
    if (this.game.isOver()) {
      this.game.init();
    }
    this.game.startTimer();
    this.isPlaying = true;
    this.isPaused = false;
    this.gameLoop();
  }

  stopGame() {
    this.isPlaying = false;
    this.isPaused = false;
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
  }

  async saveGameRecord() {
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      const historyStr = await prefs.get('gameHistory', '[]') as string;
      const history: GameRecord[] = JSON.parse(historyStr) as GameRecord[];

      const record: GameRecord = {
        score: this.game.getScore(),
        time: this.game.getFormattedTime(),
        character: this.game.getCharacter(),
        mode: this.gameMode,
        timestamp: Date.now()
      };

      history.push(record);
      // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
      if (history.length > 50) {
        history.shift();
      }

      await prefs.put('gameHistory', JSON.stringify(history));
      await prefs.flush();
      console.info('Game record saved:', record);
    } catch (err) {
      console.error('Failed to save game record:', err);
    }
  }

  pauseGame() {
    this.isPaused = true;
    if (this.timerId !== -1) {
      clearTimeout(this.timerId);
      this.timerId = -1;
    }
  }

  resumeGame() {
    this.isPaused = false;
    this.gameLoop();
  }

  restartGame() {
    this.stopGame();
    this.game.init();
    this.startGame();
  }

  gameLoop() {
    if (!this.isPlaying || this.isPaused) return;

    const success = this.game.update();
    this.updateFlag++;
    this.currentTime = this.game.getFormattedTime();
    this.drawGame();

    if (!success) {
      this.stopGame();
      // æ¸¸æˆç»“æŸæ—¶ä¿å­˜è®°å½•
      this.saveGameRecord();
      return;
    }

    this.timerId = setTimeout(() => {
      this.gameLoop();
    }, this.game.getSpeed());
  }

  handleDirection(dir: Direction) {
    this.game.setDirection(dir);
    if (!this.isPlaying && !this.game.isOver()) {
      this.startGame();
    } else if (this.isPaused) {
      this.resumeGame();
    }
  }

  handleCanvasClick(x: number, y: number) {
    if (this.controlMode !== 'click') return;

    const head = this.game.getSnake()[0];
    const headX = head.x * this.cellSize + this.cellSize / 2;
    const headY = head.y * this.cellSize + this.cellSize / 2;

    const direction = this.game.getDirection();

    // æ ¹æ®å½“å‰æ–¹å‘åˆ¤æ–­å·¦å³
    let isRight = false;
    if (direction === Direction.UP) {
      isRight = x > headX;
    } else if (direction === Direction.DOWN) {
      isRight = x < headX;
    } else if (direction === Direction.LEFT) {
      isRight = y < headY;
    } else if (direction === Direction.RIGHT) {
      isRight = y > headY;
    }

    if (isRight) {
      this.game.turnRight();
    } else {
      this.game.turnLeft();
    }

    if (!this.isPlaying && !this.game.isOver()) {
      this.startGame();
    } else if (this.isPaused) {
      this.resumeGame();
    }
  }

  getSpeedColor(): string {
    const ratio = this.game.getCurrentSpeedRatio();
    if (ratio >= 1.5) return '#FF5722'; // å¾ˆå¿« - çº¢è‰²
    if (ratio >= 1.2) return '#FF9800'; // å¿« - æ©™è‰²
    if (ratio >= 0.8) return '#4CAF50'; // æ­£å¸¸ - ç»¿è‰²
    return '#2196F3'; // æ…¢ - è“è‰²
  }

  getTransparentBg(color: string, opacity: number): string {
    // å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºrgbaæ ¼å¼
    const hex = color.replace('#', '');
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  }

  @Builder
  MenuDialog() {
    Column() {
      Text('èœå•')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.primaryText)
        .margin({ bottom: 20 })

      // è§’è‰²é€‰æ‹©æŒ‰é’®
      Button('è§’è‰²é€‰æ‹©')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.accentColor)
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.stopGame();
          router.pushUrl({
            url: 'pages/CharacterSelectPage'
          });
        })

      // æ§åˆ¶æ–¹å¼æŒ‰é’®
      Button('æ§åˆ¶æ–¹å¼')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.buttonPrimary)
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.showControlDialog = true;
        })

      // è®¾ç½®æŒ‰é’®
      if (this.gameMode === 'casual') {
        Button('è®¾ç½®')
          .width('100%')
          .height(50)
          .fontSize(18)
          .fontColor('#FFFFFF')
          .backgroundColor(this.currentTheme.successColor)
          .margin({ bottom: 15 })
          .onClick(() => {
            this.showMenuDialog = false;
            this.stopGame();
            router.pushUrl({
              url: 'pages/SettingsPage'
            });
          })
      }

      // å†å²è®°å½•æŒ‰é’®
      Button('å†å²è®°å½•')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.warningColor)
        .margin({ bottom: 15 })
        .onClick(() => {
          this.showMenuDialog = false;
          this.stopGame();
          router.pushUrl({
            url: 'pages/HistoryPage'
          });
        })

      // å–æ¶ˆæŒ‰é’®
      Button('å–æ¶ˆ')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.buttonSecondary)
        .onClick(() => {
          this.showMenuDialog = false;
        })
    }
    .width('60%')
    .padding(25)
    .backgroundColor(this.currentTheme.secondaryBg)
    .borderRadius(16)
    .shadow({ radius: 10, color: this.currentTheme.shadowColor })
  }

  @Builder
  ControlDialog() {
    Column() {
      Text('é€‰æ‹©æ§åˆ¶æ–¹å¼')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.currentTheme.primaryText)
        .margin({ bottom: 30 })

      // æŒ‰é”®æ§åˆ¶
      Column() {
        Row() {
          Radio({ value: 'button', group: 'controlGroup' })
            .checked(this.controlMode === 'button')
            .onChange((isChecked: boolean) => {
              if (isChecked) {
                this.controlMode = 'button';
              }
            })

          Column() {
            Text('æŒ‰é”®æ§åˆ¶')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 5 })

            Text('ä½¿ç”¨å±å¹•ä¸‹æ–¹çš„æ–¹å‘æŒ‰é’®æ§åˆ¶è›‡çš„ç§»åŠ¨æ–¹å‘')
              .fontSize(14)
              .fontColor(this.currentTheme.secondaryText)
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 10 })
          .layoutWeight(1)
        }
        .width('100%')
        .padding(15)
        .backgroundColor(this.controlMode === 'button' ? this.currentTheme.cardBg : this.currentTheme.borderColor)
        .borderRadius(8)
        .onClick(() => this.controlMode = 'button')
      }
      .width('100%')
      .margin({ bottom: 15 })

      // ç‚¹å‡»æ§åˆ¶
      Column() {
        Row() {
          Radio({ value: 'click', group: 'controlGroup' })
            .checked(this.controlMode === 'click')
            .onChange((isChecked: boolean) => {
              if (isChecked) {
                this.controlMode = 'click';
              }
            })

          Column() {
            Text('ç‚¹å‡»æ§åˆ¶')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 5 })

            Text('ç‚¹å‡»æ¸¸æˆåŒºåŸŸï¼šè›‡å³ä¾§å³è½¬ï¼Œè›‡å·¦ä¾§å·¦è½¬')
              .fontSize(14)
              .fontColor(this.currentTheme.secondaryText)
          }
          .alignItems(HorizontalAlign.Start)
          .margin({ left: 10 })
          .layoutWeight(1)
        }
        .width('100%')
        .padding(15)
        .backgroundColor(this.controlMode === 'click' ? this.currentTheme.cardBg : this.currentTheme.borderColor)
        .borderRadius(8)
        .onClick(() => this.controlMode = 'click')
      }
      .width('100%')
      .margin({ bottom: 30 })

      Button('ç¡®å®š')
        .width('100%')
        .height(50)
        .fontSize(18)
        .fontColor('#FFFFFF')
        .backgroundColor(this.currentTheme.buttonPrimary)
        .onClick(() => {
          this.showControlDialog = false;
        })
    }
    .width(this.dialogSize)
    .height(this.dialogSize)
    .padding(25)
    .backgroundColor(this.currentTheme.secondaryBg)
    .borderRadius(16)
    .justifyContent(FlexAlign.Center)
    .shadow({ radius: 10, color: this.currentTheme.shadowColor })
    .onAreaChange((oldValue: Area, newValue: Area) => {
      // å½“åŒºåŸŸæ”¹å˜æ—¶ï¼Œç¡®ä¿ä¿æŒæ­£æ–¹å½¢
      const width = newValue.width as number;
      this.dialogSize = Math.min(width, 400);
    })
  }

  build() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡ï¼ˆä»…ä¼‘é—²æ¨¡å¼ï¼‰- æ”¾åœ¨æœ€å¤–å±‚å æ»¡æ•´ä¸ªé¡µé¢
      if (this.bgImagePath) {
        Image($rawfile(this.bgImagePath))
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
      }

      Column() {
        // é¡¶éƒ¨ä¿¡æ¯æ 
        Column() {
          Row() {
            Button('è¿”å›')
              .fontSize(16)
              .backgroundColor(this.currentTheme.buttonSecondary)
              .fontColor('#FFFFFF')
              .onClick(() => {
                this.stopGame();
                router.back();
              })

            Row() {
              Text(`${this.gameMode === 'casual' ? 'ä¼‘é—²æ¨¡å¼' : 'æŒ‘æˆ˜æ¨¡å¼'}`)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.currentTheme.primaryText)
            }
            .layoutWeight(1)
            .justifyContent(FlexAlign.Center)

            Row() {
              Column() {
                Text(`å¾—åˆ†: ${this.game.getScore()}`)
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.currentTheme.primaryText)
                
                Text(`é€Ÿåº¦: ${this.game.getCurrentSpeedRatio().toFixed(1)}x`)
                  .fontSize(14)
                  .fontColor(this.getSpeedColor())
              }
              .alignItems(HorizontalAlign.End)
              .margin({ right: 10 })

              Button('â‹®')
                .fontSize(24)
                .width(40)
                .height(40)
                .backgroundColor(this.currentTheme.borderColor)
                .fontColor(this.currentTheme.primaryText)
                .onClick(() => {
                  this.showMenuDialog = true;
                })
            }
          }
          .width('100%')
          .height(50)
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 20, right: 20 })

          // ç¬¬äºŒè¡Œï¼šæ—¶é—´ã€é€Ÿåº¦å’Œæ§åˆ¶æŒ‰é’®
          Row() {
            Column() {
              Text(`æ—¶é—´: ${this.currentTime}`)
                .fontSize(16)
                .fontColor(this.currentTheme.secondaryText)
              
              Row() {
                Text(`é€Ÿåº¦: ${this.game.getSpeed()}ms`)
                  .fontSize(14)
                  .fontColor(this.currentTheme.hintText)
                
                if ((this.game.getCharacter() === 'xiaomao.jpg' || this.game.getCharacter() === 'xiaom.jpg' || this.game.getCharacter() === 'cat.png') && this.game.getMushroomImmunity() > 0) {
                  Text(` | ğŸ›¡ï¸Ã—${this.game.getMushroomImmunity()}`)
                    .fontSize(14)
                    .fontColor(this.currentTheme.accentColor)
                }
              }
            }
            .alignItems(HorizontalAlign.Start)

            if (this.gameMode === 'casual') {
              Row() {
                if (!this.isPlaying || this.game.isOver()) {
                  Button('å¼€å§‹')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor(this.currentTheme.successColor)
                    .fontColor('#FFFFFF')
                    .onClick(() => this.startGame())
                } else if (this.isPaused) {
                  Button('ç»§ç»­')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor(this.currentTheme.successColor)
                    .fontColor('#FFFFFF')
                    .onClick(() => this.resumeGame())
                } else {
                  Button('æš‚åœ')
                    .fontSize(14)
                    .height(32)
                    .backgroundColor(this.currentTheme.accentColor)
                    .fontColor('#FFFFFF')
                    .onClick(() => this.pauseGame())
                }

                Button('é‡å¼€')
                  .fontSize(14)
                  .height(32)
                  .backgroundColor(this.currentTheme.buttonPrimary)
                  .fontColor('#FFFFFF')
                  .margin({ left: 10 })
                  .onClick(() => this.restartGame())
              }
            }
          }
          .width('100%')
          .height(40)
          .justifyContent(FlexAlign.SpaceBetween)
          .padding({ left: 20, right: 20 })
        }
        .width('100%')
        .backgroundColor(this.getTransparentBg(this.currentTheme.secondaryBg, 0.4))

        // æ¸¸æˆåŒºåŸŸ
        Column() {
          Canvas(this.canvasContext)
            .width(this.game.getGridWidth() * this.cellSize)
            .height(this.game.getGridHeight() * this.cellSize)
            .backgroundColor('rgba(255, 255, 255, 0.3)')
            .onReady(() => {
              this.loadFruitImage();
              this.drawGame();
            })
            .onTouch((event: TouchEvent) => {
              if (event.type === TouchType.Down) {
                this.handleCanvasClick(event.touches[0].x, event.touches[0].y);
              }
            })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('rgba(0, 0, 0, 0)')

        // æ¸¸æˆç»“æŸæç¤º
        if (this.game.isOver()) {
          Column() {
            Text('æ¸¸æˆç»“æŸ!')
              .fontSize(36)
              .fontColor(this.currentTheme.dangerColor)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 15 })

            Text(`å¾—åˆ†: ${this.game.getScore()}`)
              .fontSize(24)
              .fontColor(this.currentTheme.primaryText)
              .margin({ bottom: 10 })

            Text(`å­˜æ´»æ—¶é—´: ${this.currentTime}`)
              .fontSize(20)
              .fontColor(this.currentTheme.secondaryText)
              .margin({ bottom: 30 })

            Button('é‡æ–°å¼€å§‹')
              .fontSize(20)
              .width(160)
              .height(50)
              .fontColor('#FFFFFF')
              .backgroundColor(this.currentTheme.successColor)
              .onClick(() => {
                this.restartGame();
              })
          }
          .width(300)
          .padding(30)
          .backgroundColor(this.currentTheme.secondaryBg)
          .borderRadius(16)
          .shadow({ radius: 20, color: this.currentTheme.shadowColor })
          .position({ x: '50%', y: '40%' })
          .translate({ x: '-50%', y: '-50%' })
        }

        // æš‚åœæç¤º
        if (this.isPaused && !this.game.isOver()) {
          Column() {
            Text('æ¸¸æˆå·²æš‚åœ')
              .fontSize(32)
              .fontColor(this.currentTheme.accentColor)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 20 })

            Text('ç‚¹å‡»"ç»§ç»­"æˆ–æ–¹å‘é”®æ¢å¤æ¸¸æˆ')
              .fontSize(16)
              .fontColor(this.currentTheme.secondaryText)
          }
          .width(280)
          .padding(30)
          .backgroundColor(this.currentTheme.secondaryBg)
          .borderRadius(16)
          .shadow({ radius: 20, color: this.currentTheme.shadowColor })
          .position({ x: '50%', y: '40%' })
          .translate({ x: '-50%', y: '-50%' })
        }

        // æ§åˆ¶æŒ‰é’®ï¼ˆä»…åœ¨æŒ‰é”®æ¨¡å¼æ˜¾ç¤ºï¼‰
        if (this.controlMode === 'button') {
          Column() {
            Row() {
              Button('â†‘')
                .width(80)
                .height(80)
                .fontSize(32)
                .fontColor(this.currentTheme.primaryText)
                .backgroundColor('rgba(0, 0, 0, 0)')
                .border({ width: 2, color: this.currentTheme.buttonPrimary })
                .onClick(() => this.handleDirection(Direction.UP))
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 10 })

            Row() {
              Button('â†')
                .width(80)
                .height(80)
                .fontSize(32)
                .fontColor(this.currentTheme.primaryText)
                .backgroundColor('rgba(0, 0, 0, 0)')
                .border({ width: 2, color: this.currentTheme.buttonPrimary })
                .margin({ right: 10 })
                .onClick(() => this.handleDirection(Direction.LEFT))

              Button('â†“')
                .width(80)
                .height(80)
                .fontSize(32)
                .fontColor(this.currentTheme.primaryText)
                .backgroundColor('rgba(0, 0, 0, 0)')
                .border({ width: 2, color: this.currentTheme.buttonPrimary })
                .margin({ right: 10 })
                .onClick(() => this.handleDirection(Direction.DOWN))

              Button('â†’')
                .width(80)
                .height(80)
                .fontSize(32)
                .fontColor(this.currentTheme.primaryText)
                .backgroundColor('rgba(0, 0, 0, 0)')
                .border({ width: 2, color: this.currentTheme.buttonPrimary })
                .onClick(() => this.handleDirection(Direction.RIGHT))
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
          }
          .width('100%')
          .padding({ top: 20, bottom: 40 })
          .backgroundColor('rgba(255, 255, 255, 0.1)')
        }
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.bgImagePath ? 'rgba(0, 0, 0, 0)' : this.currentTheme.primaryBg)

      // èœå•å¼¹çª—
      if (this.showMenuDialog) {
        Column() {
          this.MenuDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showMenuDialog = false;
        })
        .onAreaChange((oldValue: Area, newValue: Area) => {
          // æ ¹æ®å±å¹•å®½åº¦è°ƒæ•´å¼¹çª—å¤§å°
          const screenWidth = newValue.width as number;
          this.dialogSize = Math.min(screenWidth * 0.8, 400);
        })
      }

      // æ§åˆ¶æ–¹å¼é€‰æ‹©å¼¹çª—
      if (this.showControlDialog) {
        Column() {
          this.ControlDialog()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          this.showControlDialog = false;
        })
      }
    }
    .width('100%')
    .height('100%')
  }

  private drawGame() {
    const ctx = this.canvasContext;
    const gridWidth = this.game.getGridWidth();
    const gridHeight = this.game.getGridHeight();

    // æ¸…ç©ºç”»å¸ƒ - ä½¿ç”¨é€æ˜èƒŒæ™¯
    ctx.clearRect(0, 0, gridWidth * this.cellSize, gridHeight * this.cellSize);

    // ç»˜åˆ¶ç½‘æ ¼çº¿ - æ ¹æ®ä¸»é¢˜è®¾ç½®ç½‘æ ¼çº¿é¢œè‰²
    ctx.strokeStyle = this.currentTheme.name === 'light' ? '#E0E0E0' : '#333333';
    ctx.lineWidth = 1;
    for (let i = 0; i <= gridWidth; i++) {
      ctx.beginPath();
      ctx.moveTo(i * this.cellSize, 0);
      ctx.lineTo(i * this.cellSize, gridHeight * this.cellSize);
      ctx.stroke();
    }
    for (let i = 0; i <= gridHeight; i++) {
      ctx.beginPath();
      ctx.moveTo(0, i * this.cellSize);
      ctx.lineTo(gridWidth * this.cellSize, i * this.cellSize);
      ctx.stroke();
    }

    // ç»˜åˆ¶è›‡
    const snake = this.game.getSnake();
    snake.forEach((segment, index) => {
      if (index === 0) {
        // è›‡å¤´ä½¿ç”¨cat2å›¾ç‰‡
        if (this.catImage) {
          try {
            ctx.drawImage(
              this.catImage,
              segment.x * this.cellSize,
              segment.y * this.cellSize,
              this.cellSize,
              this.cellSize
            );
          } catch (err) {
            console.error('Failed to draw cat image:', err);
            // ç»˜åˆ¶å¤±è´¥æ—¶ä½¿ç”¨ç»¿è‰²æ–¹å—
            ctx.fillStyle = '#00FF00';
            ctx.fillRect(
              segment.x * this.cellSize + 1,
              segment.y * this.cellSize + 1,
              this.cellSize - 2,
              this.cellSize - 2
            );
          }
        } else {
          // å›¾ç‰‡æœªåŠ è½½æ—¶ä½¿ç”¨ç»¿è‰²æ–¹å—
          ctx.fillStyle = '#00FF00';
          ctx.fillRect(
            segment.x * this.cellSize + 1,
            segment.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else if (this.cartImage) {
        // è›‡èº«å’Œè›‡å°¾ä½¿ç”¨cartå›¾ç‰‡
        try {
          ctx.drawImage(
            this.cartImage,
            segment.x * this.cellSize,
            segment.y * this.cellSize,
            this.cellSize,
            this.cellSize
          );
        } catch (err) {
          console.error('Failed to draw cart image:', err);
          // ç»˜åˆ¶å¤±è´¥æ—¶ä½¿ç”¨ç»¿è‰²æ–¹å—
          ctx.fillStyle = '#00CC00';
          ctx.fillRect(
            segment.x * this.cellSize + 1,
            segment.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else {
        // å›¾ç‰‡æœªåŠ è½½æ—¶ä½¿ç”¨ç»¿è‰²æ–¹å—
        ctx.fillStyle = '#00CC00';
        ctx.fillRect(
          segment.x * this.cellSize + 1,
          segment.y * this.cellSize + 1,
          this.cellSize - 2,
          this.cellSize - 2
        );
      }
    });

    // ç»˜åˆ¶é£Ÿç‰©
    const foods = this.game.getFoods();
    
    foods.forEach(food => {
      const foodImage = this.foodImages.get(food.type);
      
      if (foodImage) {
        try {
          ctx.drawImage(
            foodImage,
            food.position.x * this.cellSize,
            food.position.y * this.cellSize,
            this.cellSize,
            this.cellSize
          );
        } catch (err) {
          console.error('Failed to draw food image:', err);
          // ç»˜åˆ¶å¤±è´¥æ—¶ä½¿ç”¨çº¢è‰²æ–¹å—
          ctx.fillStyle = '#FF0000';
          ctx.fillRect(
            food.position.x * this.cellSize + 1,
            food.position.y * this.cellSize + 1,
            this.cellSize - 2,
            this.cellSize - 2
          );
        }
      } else {
        // å›¾ç‰‡æœªåŠ è½½æ—¶ä½¿ç”¨çº¢è‰²æ–¹å—
        ctx.fillStyle = '#FF0000';
        ctx.fillRect(
          food.position.x * this.cellSize + 1,
          food.position.y * this.cellSize + 1,
          this.cellSize - 2,
          this.cellSize - 2
        );
      }
    });
  }
}

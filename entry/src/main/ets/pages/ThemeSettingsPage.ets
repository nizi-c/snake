import router from '@ohos.router';
import { ThemeManager, LightTheme, DarkTheme, Theme } from '../models/ThemeManager';

@Entry
@Component
struct ThemeSettingsPage {
  @State currentTheme: Theme = LightTheme;
  @State bgImagePath: string = '';
  private themeManager: ThemeManager = ThemeManager.getInstance();

  async aboutToAppear() {
    await this.themeManager.loadTheme(getContext(this));
    this.currentTheme = this.themeManager.getTheme();
    
    // è®¾ç½®èƒŒæ™¯å›¾ç‰‡
    this.updateBackgroundImage();
    
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    this.themeManager.addListener((theme: Theme) => {
      this.currentTheme = theme;
      this.updateBackgroundImage();
    });
  }

  updateBackgroundImage() {
    this.bgImagePath = this.currentTheme.name === 'light' ? 'startIcon.png' : 'blue_qita.png';
  }

  getTransparentBg(color: string, opacity: number): string {
    // æ·±è‰²ä¸»é¢˜ä½¿ç”¨ç™½è‰²èƒŒæ™¯ï¼Œæµ…è‰²ä¸»é¢˜ä½¿ç”¨ä¸»é¢˜é¢œè‰²
    if (this.currentTheme.name === 'dark') {
      return `rgba(255, 255, 255, ${opacity})`;
    }
    // å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºrgbaæ ¼å¼
    const hex = color.replace('#', '');
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  }

  aboutToDisappear() {
    // æ¸…ç†ç›‘å¬å™¨
    this.themeManager.removeListener((theme: Theme) => {
      this.currentTheme = theme;
    });
  }

  async switchTheme(themeName: string) {
    await this.themeManager.saveTheme(getContext(this), themeName);
    this.currentTheme = this.themeManager.getTheme();
  }

  build() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡
      if (this.bgImagePath) {
        Image($rawfile(this.bgImagePath))
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
      }

      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
        Button('è¿”å›')
          .fontSize(16)
          .backgroundColor(this.currentTheme.buttonSecondary)
          .fontColor(this.currentTheme.primaryText)
          .onClick(() => {
            router.back();
          })

        Text('è®¾ç½®')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.currentTheme.primaryText)

        // å ä½ä¿æŒå±…ä¸­
        Text('')
          .width(60)
      }
      .width('100%')
      .height(60)
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({ left: 20, right: 20 })
      .backgroundColor(this.getTransparentBg(this.currentTheme.secondaryBg, 0.6))

      // è®¾ç½®åˆ—è¡¨
      Scroll() {
        Column() {
          // ä¸»é¢˜è®¾ç½®åˆ†ç»„
          Column() {
            Text('ä¸»é¢˜è®¾ç½®')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentTheme.secondaryText)
              .width('100%')
              .padding({ left: 20, top: 20, bottom: 10 })

            // æµ…è‰²ä¸»é¢˜é€‰é¡¹
            Row() {
              Text('â˜€ï¸')
                .fontSize(32)
                .margin({ right: 15 })

              Column() {
                Text('æµ…è‰²ä¸»é¢˜')
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.currentTheme.primaryText)
                  .margin({ bottom: 4 })

                Text('æ˜åªšæ¸©æš–æŸ”å’Œ')
                  .fontSize(14)
                  .fontColor(this.currentTheme.secondaryText)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              if (this.currentTheme.name === 'light') {
                Text('âœ“')
                  .fontSize(24)
                  .fontColor(this.currentTheme.successColor)
                  .fontWeight(FontWeight.Bold)
              }
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 15, bottom: 15 })
            .backgroundColor(this.getTransparentBg(this.currentTheme.cardBg, 0.4))
            .borderRadius(12)
            .margin({ left: 15, right: 15, bottom: 10 })
            .onClick(() => {
              if (this.currentTheme.name !== 'light') {
                this.switchTheme('light');
              }
            })

            // æ·±è‰²ä¸»é¢˜é€‰é¡¹
            Row() {
              Text('ğŸŒ™')
                .fontSize(32)
                .margin({ right: 15 })

              Column() {
                Text('æ·±è‰²ä¸»é¢˜')
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor(this.currentTheme.primaryText)
                  .margin({ bottom: 4 })

                Text('å¤©è“è‰²ç³»')
                  .fontSize(14)
                  .fontColor(this.currentTheme.secondaryText)
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)

              if (this.currentTheme.name === 'dark') {
                Text('âœ“')
                  .fontSize(24)
                  .fontColor(this.currentTheme.successColor)
                  .fontWeight(FontWeight.Bold)
              }
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 15, bottom: 15 })
            .backgroundColor(this.getTransparentBg(this.currentTheme.cardBg, 0.6))
            .borderRadius(12)
            .margin({ left: 15, right: 15, bottom: 10 })
            .onClick(() => {
              if (this.currentTheme.name !== 'dark') {
                this.switchTheme('dark');
              }
            })
          }
          .width('100%')
          .margin({ bottom: 20 })

          // é¢„ç•™å…¶ä»–è®¾ç½®åˆ†ç»„çš„ä½ç½®
          // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šè®¾ç½®é¡¹
        }
        .width('100%')
      }
      .layoutWeight(1)
      .width('100%')
      .backgroundColor('rgba(0, 0, 0, 0)')
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.bgImagePath ? 'rgba(0, 0, 0, 0)' : this.currentTheme.primaryBg)
    }
    .width('100%')
    .height('100%')
  }
}

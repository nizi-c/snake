import router from '@ohos.router';
import preferences from '@ohos.data.preferences';
import { ThemeManager, LightTheme, Theme } from '../models/ThemeManager';

interface Achievement {
  id: string;
  name: string;
  description: string;
  icon: string;
  unlocked: boolean;
}

@Entry
@Component
struct AchievementPage {
  @State currentTheme: Theme = LightTheme;
  @State bgImagePath: string = '';
  @State achievements: Achievement[] = [];
  private themeManager: ThemeManager = ThemeManager.getInstance();

  async aboutToAppear() {
    await this.themeManager.loadTheme(getContext(this));
    this.currentTheme = this.themeManager.getTheme();
    
    this.updateBackgroundImage();
    
    this.themeManager.addListener((theme: Theme) => {
      this.currentTheme = theme;
      this.updateBackgroundImage();
    });
    
    await this.loadAchievements();
  }

  aboutToDisappear() {
    this.themeManager.removeListener((theme: Theme) => {
      this.currentTheme = theme;
    });
  }

  async loadAchievements() {
    try {
      const context = getContext(this);
      const prefs = await preferences.getPreferences(context, 'snake_settings');
      const achievementsStr = await prefs.get('achievements', '{}') as string;
      const unlockedAchievements = JSON.parse(achievementsStr) as Record<string, boolean>;
      
      // å®šä¹‰æ‰€æœ‰æˆå°±
      const allAchievements: Achievement[] = [
        { id: 'first_game', name: 'åˆæ¬¡é‚‚é€…', description: 'å®Œæˆç¬¬ä¸€å±€æ¸¸æˆ', icon: 'ğŸ®', unlocked: false } as Achievement,
        { id: 'food_collector', name: 'ç¾é£Ÿå¯ç¨‹', description: 'ç´¯è®¡æ”¶é›†6ä¸ªé£Ÿç‰©', icon: 'ğŸ', unlocked: false } as Achievement,
        { id: 'survival_master', name: 'ç”Ÿå­˜å¤§å¸ˆ', description: 'ä¼‘é—²æ¨¡å¼å­˜æ´»è¶…è¿‡5åˆ†é’Ÿ', icon: 'â±ï¸', unlocked: false } as Achievement,
        { id: 'score_maniac', name: 'åˆ†æ•°ç‹‚äºº', description: 'ä¼‘é—²æ¨¡å¼å•å±€å¾—åˆ†çªç ´5000åˆ†', icon: 'ğŸ†', unlocked: false } as Achievement,
        { id: 'time_master', name: 'æ—¶é—´ç®¡ç†å¤§å¸ˆ', description: 'æŒ‘æˆ˜æ¨¡å¼å‰©ä½™è¶…è¿‡1åˆ†é’Ÿå®Œæˆç›®æ ‡', icon: 'âš¡', unlocked: false } as Achievement,
        { id: 'quick_eater', name: 'è´ªåƒé¬¼', description: 'é£Ÿç‰©å‡ºç°å3ç§’å†…æ”¶é›†åˆ°å®ƒ', icon: 'ğŸ•', unlocked: false } as Achievement,
        { id: 'no_damage', name: 'æ— ä¼¤æŒ‘æˆ˜è€…', description: 'æŒ‘æˆ˜æ¨¡å¼ä¸æ¶ˆè€—ç”Ÿå‘½é€šå…³', icon: 'ğŸ›¡ï¸', unlocked: false } as Achievement,
        { id: 'last_second', name: 'æœ€åä¸€ç§’', description: 'å€’è®¡æ—¶æœ€å1ç§’å†…è¾¾æˆç›®æ ‡é€šå…³', icon: 'â°', unlocked: false } as Achievement,
        { id: 'best_collector', name: 'æœ€ä½³æ”¶é›†è€…', description: 'è¿ç»­3æ¬¡æŒ‘æˆ˜é€šå…³ä¸”æ¯æ¬¡å‰©ä½™ç”Ÿå‘½â‰¥2', icon: 'â­', unlocked: false } as Achievement
      ];
      
      // æ›´æ–°è§£é”çŠ¶æ€
      const updatedAchievements: Achievement[] = [];
      for (let i = 0; i < allAchievements.length; i++) {
        const achievement = allAchievements[i];
        updatedAchievements.push({
          id: achievement.id,
          name: achievement.name,
          description: achievement.description,
          icon: achievement.icon,
          unlocked: unlockedAchievements[achievement.id] || false
        } as Achievement);
      }
      this.achievements = updatedAchievements;
      
      console.info('Achievements loaded:', this.achievements);
    } catch (err) {
      console.error('Failed to load achievements:', err);
    }
  }

  updateBackgroundImage() {
    this.bgImagePath = this.currentTheme.name === 'light' ? 'startIcon.png' : 'blue_qita.png';
  }

  getTransparentBg(color: string, opacity: number): string {
    if (this.currentTheme.name === 'dark') {
      return `rgba(255, 255, 255, ${opacity})`;
    }
    const hex = color.replace('#', '');
    const r = parseInt(hex.substring(0, 2), 16);
    const g = parseInt(hex.substring(2, 4), 16);
    const b = parseInt(hex.substring(4, 6), 16);
    return `rgba(${r}, ${g}, ${b}, ${opacity})`;
  }

  getUnlockedCount(): number {
    return this.achievements.filter(a => a.unlocked).length;
  }

  build() {
    Stack() {
      if (this.bgImagePath) {
        Image($rawfile(this.bgImagePath))
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
      }

      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Button('è¿”å›')
            .fontSize(16)
            .backgroundColor(this.currentTheme.buttonSecondary)
            .fontColor(this.currentTheme.primaryText)
            .onClick(() => {
              router.back();
            })

          Text('æˆå°±')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.currentTheme.primaryText)

          Text('')
            .width(60)
        }
        .width('100%')
        .height(60)
        .justifyContent(FlexAlign.SpaceBetween)
        .padding({ left: 20, right: 20 })
        .backgroundColor(this.getTransparentBg(this.currentTheme.secondaryBg, 0.6))

        // æˆå°±ç»Ÿè®¡
        Row() {
          Text(`å·²è§£é”: ${this.getUnlockedCount()} / ${this.achievements.length}`)
            .fontSize(16)
            .fontColor(this.currentTheme.primaryText)
            .fontWeight(FontWeight.Medium)
        }
        .width('90%')
        .padding(15)
        .margin({ top: 15 })
        .backgroundColor(this.getTransparentBg(this.currentTheme.cardBg, 0.6))
        .borderRadius(12)

        // æˆå°±åˆ—è¡¨
        Scroll() {
          Column() {
            ForEach(this.achievements, (achievement: Achievement) => {
              Row() {
                Image($rawfile(achievement.unlocked ? 'award.png' : 'award_n.png'))
                  .width(50)
                  .height(50)
                  .margin({ right: 15 })

                Column() {
                  Text(achievement.name)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.currentTheme.primaryText)
                    .margin({ bottom: 5 })

                  Text(achievement.description)
                    .fontSize(14)
                    .fontColor(this.currentTheme.secondaryText)
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                if (achievement.unlocked) {
                  Text('âœ“')
                    .fontSize(24)
                    .fontColor(this.currentTheme.successColor)
                    .fontWeight(FontWeight.Bold)
                } else {
                  Image($rawfile('lock.png'))
                    .width(24)
                    .height(24)
                    .opacity(0.5)
                }
              }
              .width('90%')
              .padding(15)
              .margin({ top: 10, bottom: 10 })
              .backgroundColor(this.getTransparentBg(
                achievement.unlocked ? this.currentTheme.cardBg : this.currentTheme.secondaryBg,
                0.6
              ))
              .borderRadius(12)
              .border({
                width: 2,
                color: achievement.unlocked ? this.currentTheme.successColor : this.currentTheme.borderColor
              })
            })
          }
          .width('100%')
          .padding({ top: 10, bottom: 20 })
        }
        .layoutWeight(1)
        .width('100%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor(this.bgImagePath ? 'rgba(0, 0, 0, 0)' : this.currentTheme.primaryBg)
    }
    .width('100%')
    .height('100%')
  }
}
